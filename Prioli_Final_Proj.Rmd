---
title: "Quality of Life by Country:  A Clustering Analysis"
author: "Katherine M. Prioli"
date: "December 22, 2018"
output:
  pdf_document: default
  html_document: default
geometry: margin = 0.5in
references:
- URL: https://www.cdc.gov/nchs/products/databriefs/db328.htm
  author:
    - family: Murphy
      given: Sherry L.
    - family: Xu
      given: Jiaquan
    - family: Kochanek
      given: Kenneth D.
    - family: Arias
      given: Elizabeth
  id: cdc_lifeexp
  issued:
      year: 2018
  title: Mortality in the United States, 2017. NCHS Data Brief, no 328
  publisher: National Center for Health Statistics
- URL: https://github.com/kmprioliPROF/MAT_8790_Final_Project
  author:
  - family: Prioli
    given: Katherine M.
  id: kmpgit
  issued:
    month: 12
    year: 2018
  title: MAT_8790_Final_Project
- URL: http://apps.who.int/gho/data/view.main.182?lang=en
  author:
  - family: World Health Organization
  id: who_infantmort
  issued:
    year: 2018
  title: Probability of Dying per 1000 Live Births
- URL: http://apps.who.int/gho/data/view.main.SDG2016LEXv?lang=en
  author:
  - family: World Health Organization
  id: who_life
  issued:
    year: 2018
  title: Life Expectancy
- URL: http://reports.weforum.org/global-gender-gap-report-2016/rankings/
  author:
  - family: World Economic Forum
  id: wef_gender
  issued:
    year: 2016
  title: Gender Equality
- URL: http://reports.weforum.org/global-gender-gap-report-2016/measuring-the-global-gender-gap/
  author:
  - family: World Economic Forum
  id: wef_gender_desc
  issued:
    year: 2016
  title: Measuring the Global Gender Gap
- URL: https://data.worldbank.org/indicator/ny.gdp.mktp.cd?view=map&year_high_desc=true 
  author:
  - family: The World Bank
  id: worldbank_gdp
  issued:
    year: 2018
  title: Gross Domestic Product
- URL: http://hdr.undp.org/en/data
  author:
  - family: The United Nations Development Programme
  id: un_dvlpt
  issued:
    year: 2018
  title: Human Development Index
- URL: http://hdr.undp.org/en/content/human-development-index-hdi
  author:
  - family:  The United Nations Development Programme
  id: un_dvlpt_HDIdesc
  issued:
    year: 2018
  title: Human Development Reports - Human Development Index (HDI)
- URL: https://www.socialprogress.org/index
  author:
  - family: Social Progress Imperative
  id: socialprog_desc
  issued:
    year: 2018
  title:  Social Progress Index - Overview
- URL: https://www.socialprogress.org/?tab=4
  author:
  - family: Social Progress Imperative
  id: socialprog
  issued:
    year: 2018
  title: Social Progress Index
- URL: http://worldhappiness.report/ed/2018/
  author:
  - family: Helliwell
    given: John F.
  - family: Layard
    given: Richard
  - family: Sachs
    given: Jeffrey D.
  id: whr
  issued:
    year: 2018
  title: World Happiness Report
- URL: https://www-bcf.usc.edu/~gareth/ISL/
  author: 
  - family: James
    given: Gareth
  - family: Witten
    given: Daniela
  - family: Hastie
    given: Trevor
  - family: Tibshirani
    given: Robert
  id: intro_stat_learn
  issued:
    year: 2013
  title: An Introduction to Statistical Learning
  publisher: Springer
abstract: "BACKGROUND As economic globalization increases, it is important to understand how countries compare on key quality of life (QoL) measures when grouped by level of human development, and how these comparative results change by grouping approach.  In the context of recent news reports about decreasing life expectancy in the United States, it is of particular interest to understand how the United States performs compared to other countries of a similar developmental level.  METHODS Data for QoL measures of interest in calendar year 2016 was gathered and merged into a single country-level dataset.  Each variable was examined via descriptive statistics and univariate visualizations, and pairwise relationships were investigated with a correlation matrix.  The top- and bottom-ranking 20 countries were determined for each QoL measure.  For those variables for which the United States was not among the 20 highest performing countries, a series of pairwise *k*-means cluster analyses were run, with a sensitivity analysis performed on the number of clusters.  RESULTS The analytic dataset included 9 QoL variables (8 continuous, one categorical).  On country-level analysis, the US was not among the top 20 countries for 5/8 (62.5%) continuous variables, yielding 10 pairwise comparisons for clustering.  Cluster analyses showed that, for the US, life expectancy at birth was most predictive of cluster position, and was most sensitive to changes in the number of clusters.   CONCLUSION Though the United States has the world's largest economy, it underperforms on several key QoL measures.  *K*-means clustering provides a powerful tool for investigating these deficits."
---


## **Background**

The Centers for Disease Control and Prevention has recently issued a report indicating that life expectancy in the United States decreased in 2017 as compared to 2016, with the overwhelming majority of deaths caused by heart disease and cancer, arguably preventable illnesses (@cdc_lifeexp).  Given that the United States has the world's largest economy, this decline in life expectancy is particularly concerning, and indicates that national wealth may not be predictive of citizens' longevity (@worldbank_gdp). 

As the world's economies trend toward globalism, there is increasing interest in understanding how these nations compare on key quality of life (QoL) factors, including but not limted to life expectancy.  Several organizations report on QoL measures as they evolve, including among others the World Economic Forum (WEF), World Health Organization (WHO), and the United Nations Development Programme.  The QoL measures reported by these bodies can be either unidimensional values or compound scores calculated from several factors of interest.

The objective of this study was to explore the relationships between key QoL indicators by country, with particular focus on how the United States ranks, through a series of visualizations and *k*-means clustering analyses.


## **Methods**

This study included country-level QoL indicators as described in Table 1.

**Table 1.  Country-Level QoL measures.**

```{r table_1, echo = FALSE, message = FALSE, warning = FALSE}
library(tidyverse)
library(kableExtra)

meas <- c("Social Progress Index",
          "Gross Domestic Product (GDP)",
          "Human Development Index (HDI)",
          "Human Development Index (HDI)", 
          "World Happiness Score",
          "Global Gender Gap Index",
          "Infant mortality rate",
          "Life expectancy at birth", 
          "Life expectancy at sixty")
sing_comp <- c("Compound",
               "Single",
               rep("Compound", 3),
               rep("Single", 3))
measdesc <- c("Social progress level, scaled from 0:100 and comprising three broad categories:  basic human needs (e.g., nutrition, safety), foundations of wellbeing (e.g., basic knowledge, environmental quality), and opportunity (e.g., personal rights, freedoms)",
              "Valued in $US 2018", 
              "Developmental level, scale of 0:1", 
              "Developmental category, four levels (low, medium, high, very high)", 
              "Happiness score, scaled from 0:10, based on several factors including per-capita GDP, healthy life expectancy, social support, freedoms, and perception of corruption",
              "Gender equality index, scaled from 0:1, based on measurements of gender-related gaps in such dimensions as economic participation, level of education, health and survival, and political offices held", 
              "Number of infant deaths per 1,000 live births", 
              "Expected life at birth, both genders", 
              "Expected remaining life years at age 60, both genders")
measref_num <- c(1, 2, 3, 3, 4, 5, 6, 7, 7)

table_1 <- as.tibble(cbind(meas, sing_comp, measdesc, measref_num))
colnames(table_1) <- c("Measure", "Single or Compound", "Description", "Source¹")
table_1_kbl <- table_1 %>% 
  kable(format = "latex") %>% 
  column_spec(1, width = "10em", border_left = FALSE, border_right = FALSE) %>% 
  column_spec(2, width = "6em", border_left = FALSE, border_right = FALSE) %>% 
  column_spec(3, width = "29em", border_left = FALSE, border_right = FALSE) %>% 
  column_spec(4, width = "4em", border_left = FALSE, border_right = FALSE)
table_1_kbl
```
¹ Source:  **1** @socialprog_desc, **2** @worldbank_gdp, **3** @un_dvlpt_HDIdesc, **4** @whr, **5** @wef_gender_desc, **6** @who_infantmort, **7** @who_life


Data for these measures was obtained for calendar year 2016 in `.csv` or `.xls`(`x`) formats.  Additionally, dataframe containing country identifiers (full names and three-letter codes) was generated from the `countrycode` library to facilitate merging the datafiles into one tibble.


### *Wrangling and Exploration*

Each country-level datafile was imported, wrangled as needed, then tested against the dataframe containing country identifiers via `anti_join()` to identify mismatches.  Mismatching country names were manually recoded for each datafile, then all datafiles were merged using serial joins.  Countries with wholly missing data were excluded.  The resulting dataframe, titled `alldata`, is presented in Table 2.

**Table 2.  `alldata` dataframe contents.**

| **Source**       	              | **Variable Name**    	| **Description**                                  	|
|-------------------------------- |----------------------	|--------------------------------------------------	|
| @socialprog      	              | SPI                  	| Social Progress Index value (scale of 0:100)     	|
| @worldbank_gdp   	              | GDP_USD_2018         	| Gross Domestic Product (valued in $US 2018)     	|
| @un_dvlpt        	              | HDIrank              	| Human Development Index ranking                  	|
| @un_dvlpt        	              | HDIindex             	| HDI index value (scale of 0:1)                   	|
| @un_dvlpt        	              | HDI_cat              	| HDI index category (4 levels)                    	|
| @whr             	              | happiness            	| World Happiness Score (scale of 0:10)            	|
| @wef_gender      	              | gendereq 	            | Gender Equality Index (scale of 0:1)             	|
| @who_infantmort  	              | infantmort           	| Infant mortality rate                            	|
| @who_life        	              | birth_MF             	| Life expectancy at birth, males & females        	|
| @who_life        	              | sixty_MF             	| Life expectancy at 60 years, males & females     	|

At least one univariate visualization was generated for each variable in `alldata` via `ggplot()`, and a correlation matrix was produced with `GGally::ggpairs()` to investigate pairwise relationshps between variables.  Next, a series of ordered country-as-factor bivariate visualizations were created to explore the top and bottom 20 countries by ranking within each variable, with the United States denoted in red.


### *K-Means Clustering*

For the variables for which the United States was not among the top 20 performing countries on country-level visualization, a series of *k*-means cluster analyses was performed.  *K*-means clustering is described elsewhere; briefly, given bivariate data and a desired number *k* of groups, this classification algorithm classifies the points in the two-dimensional plane to minimize the total within-cluster variation for all clusters (@intro_stat_learn).  This is an iterative process that works by establishing *k* centroids, classifying each point by which centroid is closest, then moving the centroids to the center of their corrresponding clusters, and repeating the process.  Iteration terminates when the centroids no longer move, and the classification established in this terminal iteraton is the clustering.

The Human Development Index categorizes the world's countries into four developmental levels (low, medium, high, and very high); thus *k*-means clustering analysis was performed assuming 4 clusters.  Missing values were excluded to ensure the clustering algorithm would run, and a function was written to subset the clustering dataset (named `clusterdata`) to the variables of interest for each *k*-means analysis.  On each output plot, the United States was identified by an enlarged `geom_point()`.  A Shiny application was written to allow sensitivity analysis of the effect of varying *k*, with particular attention paid to any transitions between clusters for the United States with changing *k*.  For brevity, code for the Shiny application is not provided here, but is available on the GitHub repository for this project (@kmpgit).  The application can be accessed at https://kmprioli.shinyapps.io/MAT_8790_kmeans/.


### *Example Code*

For brevity, example code for wrangling, plotting, and clustering is presented here; full code is available in the GitHub repository for this report (@kmpgit).

The libraries required for this analysis were loaded as shown below.

```{r setup, include = TRUE, warning = FALSE, results = 'hide', echo = TRUE, message = FALSE}
library(tidyverse)
library(readxl)          # For importing .xls(x) datasets
library(countrycode)     # For establishing uniform country identifiers
library(ggthemr)         # For prettifying output
library(gridExtra)       # For grid.arrange()
library(grid)            # For textGrob() to annotate grid.arrange() elements
library(kableExtra)      # For nicer output tables
library(GGally)          # For ggpairs() correlation matrix
library(wesanderson)     # For Wes Anderson palette

ggthemr("fresh")                                           # Prettifying plot framework
wes <- wes_palette("Darjeeling1", 5, type = "discrete")    # Establishing color scheme for cluster plots
```

Code for establishing a crosswalk for country names and 3-letter codes:

```{r countries, include = TRUE, echo = TRUE, eval = TRUE}
countries_full <- codelist_panel %>% 
  select(country.name.en, year, genc3c, iso3c, wb_api3c) %>% 
  group_by(country.name.en) %>% 
  mutate(maxyr = max(year)) %>% 
  ungroup %>% 
  mutate(maxyr = case_when(
    maxyr == year ~ 1,
    TRUE ~ 0
  )) %>% 
  filter(maxyr == 1) %>% 
  select(-maxyr) %>% 
  distinct()

countries_full <- countries_full %>% 
  mutate(country3 = case_when(
    iso3c == genc3c & iso3c == wb_api3c ~ iso3c,
    is.na(iso3c) == FALSE ~ iso3c,
    is.na(iso3c) == TRUE & is.na(genc3c) == FALSE ~ genc3c,
    is.na(iso3c) == TRUE & is.na(genc3c) == TRUE & is.na(wb_api3c) == FALSE ~ wb_api3c
  )) %>% 
  rename(country = country.name.en) %>% 
  arrange(country)
  
countries <- countries_full %>% 
  select(country, country3)
```

Code for importing and wrangling each data file and standardizing country names (example shown for the Social Progress Index data):

<!-- Social Progress Index (SPI) data: -->

```{r SPI_wrangle, include = TRUE, echo = TRUE, eval = TRUE, message = FALSE, warning = FALSE}

# Importing, subsetting, renaming

SPI_2016_raw <- read_xlsx("data/SPIdata.xlsx", sheet = 4)

SPIdata <- SPI_2016_raw %>% 
  select(2:3) %>% 
  rename(`SPI` = `Social Progress Index`,
         country3 = Code)

# Standardizing country names by using `anti_join()` to see which 
# countries in `SPIdata` don't have a match in the `countries` dataframe

SPIanti <- SPIdata %>%
  anti_join(countries, by = "country3") %>%
  select(country3) %>%
  arrange(country3) %>% 
  unique()
dim(SPIanti)

# Correcting for mismatches with `countries` using `mutate()`

SPIdata <- SPIdata %>%
  mutate(country3 = case_when(
    country3 == "CHI" ~ as.character(NA), # Nonstandard code for Chile; omitting (no data in these rows)
    country3 == "KSV" ~ "XKS",            # Nonstandard code for Kosovo
    country3 == "NCY" ~ as.character(NA), # Turk. Repub. of N. Cyprus; omitting (conflict w/Cyprus)
    country3 == "SML" ~ as.character(NA), # Unable to determine
    country3 == "WBG" ~ as.character(NA), # West Bank / Gaza Strip; omitting (conflict w/Palestine)
    TRUE ~ as.character(country3)
  )) %>% 
  filter(!is.na(country3))

SPIanti <- SPIdata %>%
  anti_join(countries, by = "country3") %>%
  select(country3) %>%
  arrange(country3) %>% 
  unique()
dim(SPIanti)

# Removing unneeded files

rm(list = c("SPI_2016_raw", "SPIanti"))
```

<!-- Human Development Index (HDI) data: -->

```{r HDI_import, include = FALSE, echo = FALSE, eval = TRUE}

# Importing raw data

HDIraw <- read_xlsx("data/HDIdata2018.xlsx", sheet = "Table 2")

# Selecting columns of interest

HDIdata <- HDIraw %>%
  select(1:2, X__14)

# Assigning sensible column names

HDIcolnm <- c(HDIdata[[3,1]], HDIdata[[3,2]], HDIdata[[4,3]])
colnames(HDIdata) <- HDIcolnm

# Determining boundaries for human development levels in the data
# and using these to create one dataframe for each level

vhhd_st <- which(HDIdata$Country == "VERY HIGH HUMAN DEVELOPMENT") + 1
vhhd_end <- which(HDIdata$Country == "HIGH HUMAN DEVELOPMENT") - 1

hhd_st <- which(HDIdata$Country == "HIGH HUMAN DEVELOPMENT") + 1
hhd_end <- which(HDIdata$Country == "MEDIUM HUMAN DEVELOPMENT") - 1

mhd_st <- which(HDIdata$Country == "MEDIUM HUMAN DEVELOPMENT") + 1
mhd_end <- which(HDIdata$Country == "LOW HUMAN DEVELOPMENT") - 1

lhd_st <- which(HDIdata$Country == "LOW HUMAN DEVELOPMENT") + 1
lhd_end <- which(HDIdata$Country == "OTHER COUNTRIES OR TERRITORIES") - 1

oth_st <- which(HDIdata$Country == "OTHER COUNTRIES OR TERRITORIES") + 1
oth_end <- which(HDIdata$Country == "Human development groups") - 2

HDI_vhhd <- HDIdata %>% 
  slice(vhhd_st:vhhd_end) %>% 
  mutate(HDI_cat = "Very High")

HDI_hhd <- HDIdata %>% 
  slice(hhd_st:hhd_end) %>% 
  mutate(HDI_cat = "High")

HDI_mhd <- HDIdata %>% 
  slice(mhd_st:mhd_end) %>% 
  mutate(HDI_cat = "Medium")

HDI_lhd <- HDIdata %>% 
  slice(lhd_st:lhd_end) %>% 
  mutate(HDI_cat = "Low")

HDI_oth <- HDIdata %>% 
  slice(oth_st:oth_end) %>% 
  mutate(HDI_cat = NA)

# Combining the dataframes into one 

HDIdata <- bind_rows(HDI_vhhd, HDI_hhd, HDI_mhd, HDI_lhd, HDI_oth) %>% 
  rename(HDIrank = `HDI rank`) %>% 
  rename(country = Country) %>% 
  rename(HDIindex = `2016`) %>% 
  mutate(HDI_cat = factor(HDI_cat, levels = c("Low", "Medium", "High", "Very High"))) %>% 
  mutate(HDIrank = case_when(
    HDIrank == ".." ~ as.numeric(NA),
    TRUE ~ as.numeric(HDIrank)
  )) %>% 
  mutate(HDIindex = case_when(
    HDIindex == ".." ~ as.numeric(NA),
    TRUE ~ as.numeric(HDIindex)
  ))
HDIdata <- HDIdata[c(2, 1, 3:4)]
```

<!-- Testing against `countries` and correcting for conflicts: -->

```{r HDI_countryfix, include = FALSE, echo = FALSE, eval = TRUE}
HDIanti <- HDIdata %>%
  anti_join(countries, by = "country") %>%
  select(country) %>%
  arrange(country)
dim(HDIanti)

HDIdata <- HDIdata %>%
  mutate(country = case_when(
    country == "Antigua and Barbuda"                       ~ "Antigua & Barbuda",
    country == "Bolivia (Plurinational State of)"          ~ "Bolivia",
    country == "Bosnia and Herzegovina"                    ~ "Bosnia & Herzegovina",
    country == "Brunei Darussalam"                         ~ "Brunei",
    country == "Cabo Verde"                                ~ "Cape Verde",
    country == "Congo"                                     ~ "Congo - Brazzaville",
    country == "Congo (Democratic Republic of the)"        ~ "Congo - Kinshasa",
    country == "Eswatini (Kingdom of)"                     ~ "Swaziland",
    country == "Hong Kong, China (SAR)"                    ~ "Hong Kong SAR China",
    country == "Iran (Islamic Republic of)"                ~ "Iran",
    country == "Korea (Democratic People's Rep. of)"       ~ "North Korea",
    country == "Korea (Republic of)"                       ~ "South Korea",
    country == "Lao People's Democratic Republic"          ~ "Laos",
    country == "Moldova (Republic of)"                     ~ "Moldova",
    country == "Myanmar"                                   ~ "Myanmar (Burma)",
    country == "Palestine, State of"                       ~ "Palestinian Territories",
    country == "Russian Federation"                        ~ "Russia",
    country == "Saint Kitts and Nevis"                     ~ "St. Kitts & Nevis",
    country == "Saint Lucia"                               ~ "St. Lucia",
    country == "Saint Vincent and the Grenadines"          ~ "St. Vincent & Grenadines",
    country == "Syrian Arab Republic"                      ~ "Syria",
    country == "Tanzania (United Republic of)"             ~ "Tanzania",
    country == "The former Yugoslav Republic of Macedonia" ~ "Macedonia",
    country == "Trinidad and Tobago"                       ~ "Trinidad & Tobago",
    country == "Venezuela (Bolivarian Republic of)"        ~ "Venezuela",
    country == "Viet Nam"                                  ~ "Vietnam",
    country == "Côte d'Ivoire"                             ~ as.character(NA),   # UTC-8
    country == "Sao Tome and Principe"                     ~ as.character(NA),   # conflicts
    TRUE                                                   ~ as.character(country)
  )) %>% 
  filter(!is.na(country))

HDIanti <- HDIdata %>%
  anti_join(countries, by = "country") %>%
  select(country) %>%
  arrange(country)
dim(HDIanti)

rm(list = c("hhd_end", "hhd_st", "lhd_end", "lhd_st", "mhd_end", "mhd_st", "oth_end", "oth_st", "vhhd_end",
            "vhhd_st", "HDIraw", "HDIcolnm", "HDI_vhhd", "HDI_hhd", "HDI_mhd", "HDI_lhd", "HDI_oth", "HDIanti"))
```

<!-- World Happiness Score data: -->

```{r WHRdata_import, include = FALSE, echo = FALSE, eval = TRUE}
WHR_raw <- read_xls("data/WHRdata.xls", sheet = 1)
WHRdata <- WHR_raw %>% 
  select(1:3) %>% 
  rename(happiness = `Life Ladder`) %>% 
  filter(year == 2016) %>% 
  select(-year)
```

<!-- Testing against `countries` and correcting for conflicts: -->

```{r WHR_countrytest, include = FALSE, echo = FALSE, eval = TRUE}
WHRanti <- WHRdata %>%
  anti_join(countries, by = "country") %>%
  select(country) %>%
  arrange(country) %>% 
  unique()
dim(WHRanti)

WHRdata <- WHRdata %>% 
  mutate(country = case_when(
    country == "Bosnia and Herzegovina"                    ~ "Bosnia & Herzegovina",
    country == "Congo (Brazzaville)"                       ~ "Congo - Brazzaville",
    country == "Congo (Kinshasa)"                          ~ "Congo - Kinshasa",
    country == "Czech Republic"                            ~ "Czechia",
    country == "Hong Kong S.A.R. of China"                 ~ "Hong Kong SAR China",
    country == "Myanmar"                                   ~ "Myanmar (Burma)",
    country == "Taiwan Province of China"                  ~ "Taiwan",
    country == "Trinidad and Tobago"                       ~ "Trinidad & Tobago",
    country == "North Cyprus"                              ~ as.character(NA),   # conflicts w/Cyprus
    country == "Ivory Coast"                               ~ as.character(NA),   # UTC-8 conflicts;
    TRUE                                                   ~ as.character(country)
  )) %>% 
  filter(!is.na(country))

WHRanti <- WHRdata %>%
  anti_join(countries, by = "country") %>%
  select(country) %>%
  arrange(country) %>% 
  unique()
dim(WHRanti)

# Removing unneeded files

rm(list = c("WHR_raw", "WHRanti"))
```

<!-- World Economic Forum Gender Equality Index data: -->

```{r gender_import, include = FALSE, echo = FALSE, eval = TRUE}
gender_raw <- read_xlsx("data/WEF_gender.xlsx", sheet = 2, range = "$A$2:$K$147")
gender_raw <- gender_raw %>% 
  select(1:2)
colnames(gender_raw) <- c("country", "gendereq")
genderdata <- gender_raw %>% 
  slice(2:dim(gender_raw)[1]) %>% 
  mutate(gendereq = as.numeric(gendereq))
```

<!-- Testing against `countries` and correcting for conflicts: -->

```{r gender_countrytest, include = FALSE, echo = FALSE, eval = TRUE}
genderanti <- genderdata %>%
  anti_join(countries, by = "country") %>%
  select(country) %>%
  arrange(country) %>% 
  unique()
dim(genderanti)

genderdata <- genderdata %>%
  mutate(country = case_when(
    country == "Bosnia and Herzegovina"                    ~ "Bosnia & Herzegovina",
    country == "Brunei Darussalam"                         ~ "Brunei",
    country == "Czech Republic"                            ~ "Czechia",
    country == "Gambia, The"                               ~ "Gambia",
    country == "Iran, Islamic Rep."                        ~ "Iran",
    country == "Korea, Rep."                               ~ "South Korea",
    country == "Kyrgyz Republic"                           ~ "Kyrgyzstan",
    country == "Lao PDR"                                   ~ "Laos",
    country == "Macedonia, FYR"                            ~ "Macedonia",
    country == "Russian Federation"                        ~ "Russia",
    country == "Slovak Republic"                           ~ "Slovakia",
    country == "Trinidad and Tobago"                       ~ "Trinidad & Tobago",
    country == "Côte d'Ivoire"                             ~ as.character(NA),   # UTC-8 conflict
    TRUE                                                   ~ as.character(country)
  )) %>% 
  filter(!is.na(country))

genderanti <- genderdata %>%
  anti_join(countries, by = "country") %>%
  select(country) %>%
  arrange(country) %>% 
  unique()
dim(genderanti)

# Removing unneeded files

rm(list = c("gender_raw", "genderanti"))
```

<!-- World Health Organization infant mortality rate data: -->

```{r infantmort_import, include = FALSE, echo = FALSE, eval = TRUE}
infantmort_raw <- read_csv("data/WHO_infantmort.csv")
infantmortdata <- infantmort_raw %>% 
  select(1, 3) %>% 
  rename(country = Country) %>% 
  rename(infantmort = `Infant mortality rate (probability of dying between birth and age 1 per 1000 live births)`) %>% 
  mutate(infantmort = as.numeric(infantmort) / 1000)
```

<!-- Testing against `countries` and correcting for conflicts: -->

```{r infantmort_countrytest, include = FALSE, echo = FALSE, eval = TRUE}
infantmortanti <- infantmortdata %>%
  anti_join(countries, by = "country") %>%
  select(country) %>%
  arrange(country) %>% 
  unique()
dim(infantmortanti)

infantmortdata <- infantmortdata %>% 
  mutate(country = case_when(
    country == "Antigua and Barbuda"                                  ~ "Antigua & Barbuda",
    country == "Bolivia (Plurinational State of)"                     ~ "Bolivia",
    country == "Bosnia and Herzegovina"                               ~ "Bosnia & Herzegovina",
    country == "Brunei Darussalam"                                    ~ "Brunei",
    country == "Cabo Verde"                                           ~ "Cape Verde",
    country == "Congo"                                                ~ "Congo - Brazzaville",
    country == "Democratic People's Republic of Korea"                ~ "North Korea",
    country == "Democratic Republic of the Congo"                     ~ "Congo - Kinshasa",
    country == "Eswatini"                                             ~ "Swaziland",
    country == "Iran (Islamic Republic of)"                           ~ "Iran",
    country == "Lao People's Democratic Republic"                     ~ "Laos",
    country == "Myanmar"                                              ~ "Myanmar (Burma)",
    country == "Republic of Korea"                                    ~ "South Korea",
    country == "Republic of Moldova"                                  ~ "Moldova",
    country == "Russian Federation"                                   ~ "Russia",
    country == "Saint Kitts and Nevis"                                ~ "St. Kitts & Nevis",
    country == "Saint Lucia"                                          ~ "St. Lucia",
    country == "Saint Vincent and the Grenadines"                     ~ "St. Vincent & Grenadines",
    country == "Syrian Arab Republic"                                 ~ "Syria",
    country == "The former Yugoslav republic of Macedonia"            ~ "Macedonia",
    country == "Trinidad and Tobago"                                  ~ "Trinidad & Tobago",
    country == "United Kingdom of Great Britain and Northern Ireland" ~ "United Kingdom",
    country == "United Republic of Tanzania"                          ~ "Tanzania",
    country == "United States of America"                             ~ "United States",
    country == "Venezuela (Bolivarian Republic of)"                   ~ "Venezuela",
    country == "Viet Nam"                                             ~ "Vietnam",
    country == "Côte d'Ivoire"                                        ~ as.character(NA),   # UTC-8
    country == "Sao Tome and Principe"                                ~ as.character(NA),   # conflicts
    TRUE                                                              ~ as.character(country)
  )) %>% 
  filter(!is.na(country))

infantmortanti <- infantmortdata %>%
  anti_join(countries, by = "country") %>%
  select(country) %>%
  arrange(country) %>% 
  unique()
dim(infantmortanti)

rm(list = c("infantmort_raw", "infantmortanti"))
```

<!-- World Health Organization life expectancy data: -->

```{r lifeexp_import, include = FALSE, echo = FALSE, eval = TRUE}
lifeexp_raw <- read_csv("data/WHO_lifeexp.csv")
lifeexp_raw <- lifeexp_raw %>% select(1:3, 6)

lifeexp_sub <- lifeexp_raw

colnames(lifeexp_sub) <- c("country", "year", "birth_MF", "sixty_MF")
lifeexpdata <- lifeexp_sub %>% 
  slice(2:length(country)) %>% 
  mutate(year = as.numeric(year)) %>% 
  mutate(birth_MF = as.numeric(birth_MF)) %>% 
  mutate(sixty_MF = as.numeric(sixty_MF)) %>% 
  filter(year == 2016) %>% 
  select(-year)
```

<!-- Testing against `countries` and correcting for conflicts: -->

```{r lifeexp_countrytest, include = FALSE, echo = FALSE, eval = TRUE}
lifeexpanti <- lifeexpdata %>%
  anti_join(countries, by = "country") %>%
  select(country) %>%
  arrange(country) %>% 
  unique()
dim(lifeexpanti)

lifeexpdata <- lifeexpdata %>% 
  mutate(country = case_when(
    country == "Antigua and Barbuda"                                  ~ "Antigua & Barbuda",
    country == "Bolivia (Plurinational State of)"                     ~ "Bolivia",
    country == "Bosnia and Herzegovina"                               ~ "Bosnia & Herzegovina",
    country == "Brunei Darussalam"                                    ~ "Brunei",
    country == "Cabo Verde"                                           ~ "Cape Verde",
    country == "Congo"                                                ~ "Congo - Brazzaville",
    country == "Democratic People's Republic of Korea"                ~ "North Korea",
    country == "Democratic Republic of the Congo"                     ~ "Congo - Kinshasa",
    country == "Eswatini"                                             ~ "Swaziland",
    country == "Iran (Islamic Republic of)"                           ~ "Iran",
    country == "Lao People's Democratic Republic"                     ~ "Laos",
    country == "Myanmar"                                              ~ "Myanmar (Burma)",
    country == "Republic of Korea"                                    ~ "South Korea",
    country == "Republic of Moldova"                                  ~ "Moldova",
    country == "Russian Federation"                                   ~ "Russia",
    country == "Saint Lucia"                                          ~ "St. Lucia",
    country == "Saint Vincent and the Grenadines"                     ~ "St. Vincent & Grenadines",
    country == "Syrian Arab Republic"                                 ~ "Syria",
    country == "The former Yugoslav republic of Macedonia"            ~ "Macedonia",
    country == "Trinidad and Tobago"                                  ~ "Trinidad & Tobago",
    country == "United Kingdom of Great Britain and Northern Ireland" ~ "United Kingdom",
    country == "United Republic of Tanzania"                          ~ "Tanzania",
    country == "United States of America"                             ~ "United States",
    country == "Venezuela (Bolivarian Republic of)"                   ~ "Venezuela",
    country == "Viet Nam"                                             ~ "Vietnam",
    country == "Côte d'Ivoire"                                        ~ as.character(NA),   # UTC-8
    country == "Sao Tome and Principe"                                ~ as.character(NA),   # conflicts
    TRUE                                                              ~ as.character(country)
  )) %>% 
  filter(!is.na(country))

lifeexpanti <- lifeexpdata %>%
  anti_join(countries, by = "country") %>%
  select(country) %>%
  arrange(country) %>% 
  unique()
dim(lifeexpanti)

# Removing unneeded files

rm(list = c("lifeexp_raw", "lifeexp_sub"))
```

<!-- World Bank Gross Domestic Product (GDP) data: -->

```{r GDP_import, include = FALSE, echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE}
GDPraw <- read_csv("data/GDPdata.csv")

GDPcolnames <- GDPraw %>% slice(4:4)
GDPsub <- GDPraw %>% 
  slice(-(1:4))
colnames(GDPsub) <- GDPcolnames

GDPdata <- GDPsub %>% 
  rename(country = `Country Name`) %>% 
  rename(country3 = `Country Code`) %>% 
  select(-(3:44)) %>%
  gather(3:20, key = "year", value = "GDP_USD_2018") %>%      # Valuation is in $US 2018
  mutate(year = as.numeric(year)) %>% 
  filter(year == 2016) %>% 
  select(-year)
```

<!-- Testing against `countries` and correcting for conflicts: -->

```{r GDP_countrytest, include = FALSE, echo = FALSE, eval = TRUE}
GDPanti <- GDPdata %>%
  anti_join(countries, by = "country3") %>%
  select(country3, country) %>%
  arrange(country3, country) %>% 
  unique()
dim(GDPanti)

GDPdata <- GDPdata %>% 
  mutate(country3 = case_when(
    country3 == "XKX" ~ "XKS",
    country3 == "CHI" ~ as.character(NA), # Channel Islands
    country3 %in% c("ARB", "CEB", "CSS", "EAP", "EAR", "EAS", "ECA", "ECS", "EMU",  # Region-of-world codes
                    "EUU", "FCS", "HIC", "HPC", "IBD", "IBT", "IDA", "IDB", "IDX",  # (not country codes)
                    "INX", "LAC", "LCN", "LDC", "LIC", "LMC", "LMY", "LTE", "MEA", 
                    "MIC", "MNA", "NAC", "OED", "OSS", "PRE", "PSS", "PST", "SAS", 
                    "SSA", "SSF", "SST", "TEA", "TEC", "TLA", "TMN", "TSA", "TSS", 
                    "UMC", "WLD") ~ as.character(NA),
    TRUE ~ as.character(country3)
  )) %>% 
  filter(!is.na(country3)) %>% 
  select(-country)

GDPanti <- GDPdata %>%
  anti_join(countries, by = "country3") %>%
  select(country3) %>%
  arrange(country3) %>% 
  unique()
dim(GDPanti)

# Removing unneeded files

rm(list = c("GDPraw", "GDPsub", "GDPcolnames", "GDPanti"))
```

Code to combine individual data files into one dataframe and filter out countries with no data:

```{r combine, include = TRUE, echo = TRUE, eval = TRUE}
joindata_1 <- full_join(countries, HDIdata, by = "country")
joindata_2 <- left_join(joindata_1, SPIdata, by = "country3")
joindata_3 <- left_join(joindata_2, WHRdata, by = "country")
joindata_4 <- left_join(joindata_3, genderdata, by = "country")
joindata_5 <- left_join(joindata_4, infantmortdata, by = "country")
joindata_6 <- left_join(joindata_5, lifeexpdata, by = "country")
joindata_7 <- left_join(joindata_6, GDPdata, by = "country3")

joinsub <- joindata_7 %>% 
  arrange(country) %>% 
  mutate(exclude_flag = case_when(
    is.na(HDIrank) == TRUE & 
      is.na(HDIindex) == TRUE &
      is.na(HDI_cat) == TRUE &
      is.na(SPI) == TRUE &
      is.na(happiness) == TRUE &
      is.na(gendereq) == TRUE &
      is.na(infantmort) == TRUE &
      is.na(birth_MF) == TRUE &
      is.na(sixty_MF) == TRUE &
      is.na(GDP_USD_2018) == TRUE             ~ TRUE,
    TRUE                                      ~ FALSE
  )) %>% 
  filter(exclude_flag == FALSE) %>% 
  select(-exclude_flag)

alldata <- joinsub %>% 
  mutate(country = factor(country)) %>% 
  mutate(country3 = factor(country3)) %>% 
  mutate(US = case_when(                            # Flag for US vs non-US
    country == "United States" ~ "US",
    TRUE                       ~ "Non US"
  )) %>% 
  mutate(color = case_when(                         # Color var for use in country-level plots
    country == "United States" ~ "#FF0000",
    TRUE                       ~ "#545454"
  ))

alldata <- alldata[c(1:2, 13:14, 6, 12, 3:5, 7:11)]

len <- dim(alldata)[[1]]                            # For use in calculating histogram bin number

# write_csv(alldata, paste0("data/alldata_", lubridate::today(),".csv"))  # Uncomment to export data
```

```{r join_remove, include = FALSE, echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE}
# Removing unneeded files

rm(list = c("joindata_1", "joindata_2", "joindata_3", "joindata_4",
            "joindata_5", "joindata_6", "joindata_7", "joinsub"))
```

Example code for univariate explorations:

```{r SPIplot_code, include = TRUE, echo = TRUE, eval = FALSE, warning = FALSE, message = FALSE, fig.width = 10, fig.height = 4}
SPI_hist <- ggplot(data = alldata, aes(x = SPI)) +
  geom_histogram(bins = ceiling(sqrt(len - sum(is.na(alldata$SPI))))) +
  xlab("Social Progress Index") +
  ylab("Count") +
  ggtitle("Figure 1.  Social Progress Index Distribution")

SPIsumm <- broom::tidy(round(summary(alldata$SPI), digits = 3))
sd <- round(sd(alldata$SPI, na.rm = TRUE), digits = 3)
SPIsumm <- cbind(SPIsumm, sd)
colnames(SPIsumm) <- c("Min", "Q1", "Median", "Mean", "Q3", "Max", "NA", "SD")
SPIsumm <- SPIsumm[c(1:6,8,7)]
SPIsumm_grob <- tableGrob(t(SPIsumm), theme = ttheme_minimal())

grid.arrange(SPI_hist, SPIsumm_grob, nrow = 1, widths = c(0.8, 0.2))
```

Example ordered country-level plot code:

```{r SPI_country_code, include = TRUE, echo = TRUE, eval = FALSE, warning = FALSE, message = FALSE, fig.height = 6, fig.width = 8}
alldata_SPI <- alldata %>%
  filter(!is.na(SPI) == TRUE) %>% 
  arrange(desc(SPI)) %>% 
  select(SPI, country, US, color)

alldata_SPI_top20 <- alldata_SPI %>% head(20)
alldata_SPI_bot20 <- alldata_SPI %>% tail(20)
alldata_SPI40 <- bind_rows(alldata_SPI_top20, alldata_SPI_bot20)

colors <- alldata_SPI40$color[order(alldata_SPI40$SPI)]

SPI_country_point <- ggplot(data = alldata_SPI40, aes(x = SPI, 
                                                      y = fct_reorder(country, SPI), color = US)) +
  geom_point() +
  scale_color_manual(values = c("US" = "#FF0000", "Non US" = "#5BBCD6")) +
  theme(axis.text.y = element_text(color = colors)) +
  guides(color = FALSE) +
  xlim(0, 100) +
  xlab("SPI") +
  ylab("Country") +
  ggtitle("Figure 9.  Social Progress Index by Country")
```

Example clustering code:

```{r kmeans_example, echo = TRUE, eval = FALSE}
kmdata <- kmdf(clusterdata, "country", "happiness", "gendereq")

set.seed(19811221)
km_subset <- kmeans(kmdata[, 2:3], 4)
km_subset_cluster <- as.factor(km_subset$cluster)

clusterdata1 <- cbind(clusterdata, km_subset_cluster)

km_happiness_gendereq_plot <- ggplot(data = clusterdata1,
                                     aes(x = happiness, y = gendereq, 
                                         color = km_subset_cluster,
                                         size = US,
                                         shape = HDI_cat)) +
  geom_point() +
  scale_color_manual(values = wes) +
  scale_shape_manual(values = c(18, 17, 15, 16)) +
  guides(color = guide_legend(title = "Cluster"), 
         size = FALSE, 
         shape = guide_legend(reverse = TRUE, title = "HDI Category")) +
  xlab("Happiness Score") +
  ylab("Gender Equality Index") +
  ggtitle("Figure 16.  Cluster Analysis, Gender Equality Index vs. Happiness Score")
km_happiness_gendereq_plot
```


## **Results**

### *Data Exploration and Visualizations*

The Social Progress Index data ranges from `r round(min(alldata$SPI, na.rm = TRUE), digits = 2)` to `r round(max(alldata$SPI, na.rm = TRUE), digits = 2)` and appears trimodal (Fig. 1).

```{r SPIplot, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 10, fig.height = 4}
SPI_hist <- ggplot(data = alldata, aes(x = SPI)) +
  geom_histogram(bins = ceiling(sqrt(len - sum(is.na(alldata$SPI))))) +
  xlab("Social Progress Index") +
  ylab("Count") +
  ggtitle("Figure 1.  Social Progress Index Distribution")

SPIsumm <- broom::tidy(round(summary(alldata$SPI), digits = 3))
sd <- round(sd(alldata$SPI, na.rm = TRUE), digits = 3)
SPIsumm <- cbind(SPIsumm, sd)
colnames(SPIsumm) <- c("Min", "Q1", "Median", "Mean", "Q3", "Max", "NA", "SD")
SPIsumm <- SPIsumm[c(1:6,8,7)]
SPIsumm_grob <- tableGrob(t(SPIsumm), theme = ttheme_minimal())

grid.arrange(SPI_hist, SPIsumm_grob, nrow = 1, widths = c(0.8, 0.2))
```

Table 3 shows summary statistics for the raw GDP values.  These are unwieldy; however, after log transformation, the data is reasonably normally distributed, with mean `r round(mean(log(alldata$GDP_USD_2018), na.rm = TRUE), digits = 2)` and standard deviation `r round(sd(log(alldata$GDP_USD_2018), na.rm = TRUE), digits = 2)` (Fig. 2).


**Table 3.  Summary Statistics for `GDP_USD_2018`**

```{r GDPsumm, echo = FALSE, warning = FALSE, message = FALSE}
GDPsumm <- broom::tidy(round(summary(alldata$GDP_USD_2018), digits = 3))
sd <- round(sd(alldata$GDP_USD_2018, na.rm = TRUE), digits = 3)
GDPsumm <- cbind(GDPsumm, sd)
colnames(GDPsumm) <- c("Min", "Q1", "Median", "Mean", "Q3", "Max", "NA", "SD")
GDPsumm <- GDPsumm[c(1:6,8,7)]
GDPsumm <- GDPsumm %>% kable(format = "markdown")
GDPsumm
```


```{r GDPplot, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 10, fig.height = 4}
GDP_hist <- ggplot(data = alldata, aes(x = log(GDP_USD_2018))) +
  geom_histogram(bins = ceiling(sqrt(len - sum(is.na(alldata$GDP_USD_2018))))) +
  xlab("log(GDP)") +
  ylab("Count") +
  ggtitle("Figure 2.  Gross Domestic Product Distribution, Log Transform")

logGDPsumm <- broom::tidy(round(summary(log(alldata$GDP_USD_2018)), digits = 3))
sd <- round(sd(log(alldata$GDP_USD_2018), na.rm = TRUE), digits = 3)
logGDPsumm <- cbind(logGDPsumm, sd)
colnames(logGDPsumm) <- c("Min", "Q1", "Median", "Mean", "Q3", "Max", "NA", "SD")
logGDPsumm <- logGDPsumm[c(1:6,8,7)]
logGDPsumm_grob <- tableGrob(t(logGDPsumm), theme = ttheme_minimal())

grid.arrange(GDP_hist, logGDPsumm_grob, nrow = 1, widths = c(0.8, 0.2))
```

The Human Development Index data (Fig. 3) appears multimodal, with the "very high" developmental category the most represented in the data.

```{r HDIplots, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 10, fig.height = 4}
HDIindex_hist <- ggplot(data = alldata, aes(x = HDIindex)) +
  geom_histogram(bins = ceiling(sqrt(len - sum(is.na(alldata$HDIindex))))) +
  xlab("Human Development Index") +
  ylab("Count") +
  ggtitle("HDI Distribution")

HDIcat_bar <- ggplot(data = alldata, aes(x = HDI_cat)) +
  geom_bar() +
  geom_text(stat = "count", aes(label = ..count..), color = "#233b43",
            hjust = 0.5, position = position_stack(vjust = 0.5)) +
  xlab("Human Development Category") +
  ylab("Count") +
  ggtitle("Country Counts by HDI Category")

HDIsumm <- broom::tidy(round(summary(alldata$HDIindex), digits = 3))
sd <- round(sd(alldata$HDIindex, na.rm = TRUE), digits = 3)
HDIsumm <- cbind(HDIsumm, sd)
colnames(HDIsumm) <- c("Min", "Q1", "Median", "Mean", "Q3", "Max", "NA", "SD")
HDIsumm <- HDIsumm[c(1:6,8,7)]
HDIsumm_grob <- tableGrob(HDIsumm, theme = ttheme_minimal(), rows = NULL)

grid.arrange(HDIindex_hist, HDIcat_bar, HDIsumm_grob, nrow = 2, heights = c(0.8, 0.2),
             top = textGrob("Figure 3.  Human Development Index", 
                            gp = gpar(fontsize = 14, fontface = "bold", col = "#545454"),
                            x = 0.025, hjust = 0))
```

Figure 4 shows that the Happiness Score is reasonably normally distributed, having values ranging from `r round(min(alldata$happiness, na.rm = TRUE), digits = 2)` to `r round(max(alldata$happiness, na.rm = TRUE), digits = 2)`.

```{r happinessplot, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 10, fig.height = 4}
happiness_hist <- ggplot(data = alldata, aes(happiness)) +
  geom_histogram(bins = ceiling(sqrt(len - sum(is.na(alldata$happiness))))) +
  xlab("Happiness Score") +
  ylab("Count") +
  ggtitle("Figure 4.  Happiness Score Distribution")

happinesssumm <- broom::tidy(round(summary(alldata$happiness), digits = 3))
sd <- round(sd(alldata$happiness, na.rm = TRUE), digits = 3)
happinesssumm <- cbind(happinesssumm, sd)
colnames(happinesssumm) <- c("Min", "Q1", "Median", "Mean", "Q3", "Max", "NA", "SD")
happinesssumm <- happinesssumm[c(1:6,8,7)]
happinesssumm_grob <- tableGrob(t(happinesssumm), theme = ttheme_minimal())

grid.arrange(happiness_hist, happinesssumm_grob, nrow = 1, widths = c(0.8, 0.2))
```

Figure 5 shows that the gender equality index is roughly symmetric in distribution, with mean and median quite close in value (`r round(mean(alldata$gendereq, na.rm = TRUE), digits = 4)` and `r round(median(alldata$gendereq, na.rm = TRUE), digits = 4)` respectively).

```{r genderplot, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 10, fig.height = 4}
gender_hist <- ggplot(data = alldata, aes(x = gendereq)) +
  geom_histogram(bins = ceiling(sqrt(len - sum(is.na(alldata$gendereq))))) +
  xlab("Gender Equality Index") +
  ylab("Count") +
  ggtitle("Figure 5.  Gender Equality Index Distribution")

gendersumm <- broom::tidy(round(summary(alldata$gendereq), digits = 3))
sd <- round(sd(alldata$gendereq, na.rm = TRUE), digits = 3)
gendersumm <- cbind(gendersumm, sd)
colnames(gendersumm) <- c("Min", "Q1", "Median", "Mean", "Q3", "Max", "NA", "SD")
gendersumm <- gendersumm[c(1:6,8,7)]
gendersumm_grob <- tableGrob(t(gendersumm), theme = ttheme_minimal())

grid.arrange(gender_hist, gendersumm_grob, nrow = 1, widths = c(0.8, 0.2))
```

The infant mortality data (Fig. 6) is strongly right-skewed.

```{r infantmortplot, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 10, fig.height = 4}
infantmort_hist <- ggplot(data = alldata, aes(x = infantmort)) + 
  geom_histogram(bins = ceiling(sqrt(len - sum(is.na(alldata$gendereq))))) +
  xlab("Probability of Infant Mortality") +
  ylab("Count") +
  ggtitle("Figure 6.  Infant Mortality Distribution")

infantmortsumm <- broom::tidy(round(summary(alldata$infantmort), digits = 3))
sd <- round(sd(alldata$infantmort, na.rm = TRUE), digits = 3)
infantmortsumm <- cbind(infantmortsumm, sd)
colnames(infantmortsumm) <- c("Min", "Q1", "Median", "Mean", "Q3", "Max", "NA", "SD")
infantmortsumm <- infantmortsumm[c(1:6,8,7)]
infantmortsumm_grob <- tableGrob(t(infantmortsumm), theme = ttheme_minimal())

grid.arrange(infantmort_hist, infantmortsumm_grob, nrow = 1, widths = c(0.8, 0.2))
```

The total life expectancy data (Fig. 7) shows that total life expectancy for those who reach 60 years of age is greater than that for the general population at birth.

```{r lifeexpplot, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 10, fig.height = 4}
lifeexp_birth_box <- ggplot(data = alldata, aes(y = birth_MF)) +
  geom_boxplot() +
  ylim(50, 100) +
  ylab("Total Life Expectancy (years)") +
  ggtitle("...at Birth") +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank())

lifeexp_sixty_box <- ggplot(data = alldata, aes(y = 60 + sixty_MF)) +
  geom_boxplot() +
  ylim(50, 100) +
  ylab("") +
  ggtitle("...at Age 60") +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.line.y.left = element_blank())


birth_MFsumm <- broom::tidy(round(summary(alldata$birth_MF), digits = 3))
sd <- round(sd(alldata$birth_MF), digits = 3)
birth_MFsumm <- cbind(birth_MFsumm, sd)
colnames(birth_MFsumm) <- c("Min", "Q1", "Median", "Mean", "Q3", "Max", "SD")
birth_MFsumm_grob <- tableGrob(birth_MFsumm, theme = ttheme_minimal(), rows = NULL)


birth_MFsumm <- broom::tidy(round(summary(alldata$birth_MF), digits = 3))
sd <- round(sd(alldata$birth_MF, na.rm = TRUE), digits = 3)
birth_MFsumm <- cbind(birth_MFsumm, sd)
colnames(birth_MFsumm) <- c("Min", "Q1", "Median", "Mean", "Q3", "Max", "NA", "SD")
birth_MFsumm <- birth_MFsumm[c(1:6,8,7)]
birth_MFsumm_grob <- tableGrob(birth_MFsumm, theme = ttheme_minimal(), rows = NULL)


sixty_MFsumm <- broom::tidy(round(summary(alldata$sixty_MF + 60), digits = 3))
sd <- round(sd(alldata$sixty_MF + 60, na.rm = TRUE), digits = 3)
sixty_MFsumm <- cbind(sixty_MFsumm, sd)
colnames(sixty_MFsumm) <- c("Min", "Q1", "Median", "Mean", "Q3", "Max", "NA", "SD")
sixty_MFsumm <- sixty_MFsumm[c(1:6,8,7)]
sixty_MFsumm_grob <- tableGrob(sixty_MFsumm, theme = ttheme_minimal(), rows = NULL)


grid.arrange(lifeexp_birth_box, lifeexp_sixty_box, 
             birth_MFsumm_grob, sixty_MFsumm_grob, 
             nrow = 2, heights = c(0.8, 0.2),
             top = textGrob("Figure 7.  Total Life Expectancy...",
                            gp = gpar(fontsize = 14, fontface = "bold", col = "#545454"),
                            x = 0.025, hjust = 0))
```

When investigating pairwise relationships (Fig. 8), strong positive linear relationships were seen between `HDIindex` and `SPI`, `happiness`, and `birth_MF`; between `SPI` and `happiness`, `birth_MF`, and `sixty_MF`; and between `happiness` and `sixty_MF`.  Additionally, strong positive relationships that are possibly nonlinear are seen between `HDI_index` and `sixty_MF`, and between `birth_MF` and `sixty_MF`.

Strong negative relationships are seen between `infantmort` and `birth_MF`, between `HDIindex` and `infantmort`, and between `SPI` and `infantmort`, though the latter two of these may not necessarily be linear.  A strong negative nonlinear relationship is seen between `infantmort` and `sixty_MF`.

Strong differences are seen by `HDI_cat` for `infantmort`, `birth_MF`, and `sixty_MF`.

```{r calc_corrplot, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 10, fig.height = 8}
alldata <- alldata %>% mutate(logGDP = log(GDP_USD_2018))

corrplot <- ggpairs(data = alldata, columns = c(5, 15, 8:14),
                    title = "Figure 8.  Correlation Matrix")
corrplot
```

### *Top and Bottom 20 Countries by QoL Measure*

When assessing the top and bottom 20 countries by Social Progress Index, the United States was found to rank twentieth (Fig. 9).

```{r SPI_country, echo = FALSE, fig.height = 5, fig.width = 8}
alldata_SPI <- alldata %>% 
  filter(!is.na(SPI) == TRUE) %>% 
  arrange(desc(SPI)) %>% 
  select(SPI, country, US, color)

alldata_SPI_top20 <- alldata_SPI %>% head(20)
alldata_SPI_bot20 <- alldata_SPI %>% tail(20)
alldata_SPI40 <- bind_rows(alldata_SPI_top20, alldata_SPI_bot20)

colors <- alldata_SPI40$color[order(alldata_SPI40$SPI)]

SPI_country_point <- ggplot(data = alldata_SPI40, aes(x = SPI, 
                                                      y = fct_reorder(country, SPI), color = US)) +
  geom_point() +
  scale_color_manual(values = c("US" = "#FF0000", "Non US" = "#5BBCD6")) +
  theme(axis.text.y = element_text(color = colors)) +
  guides(color = FALSE) +
  xlim(0, 100) +
  xlab("SPI") +
  ylab("Country") +
  ggtitle("Figure 9.  Social Progress Index by Country")
SPI_country_point
```

The United States has the world's largest GDP (Fig. 10).

```{r GDP_country, echo = FALSE, fig.height = 6, fig.width = 9}
alldata_GDP <- alldata %>%
  filter(!is.na(GDP_USD_2018) == TRUE) %>% 
  arrange(desc(GDP_USD_2018)) %>% 
  select(GDP_USD_2018, country, US, color)

alldata_GDP_top20 <- alldata_GDP %>% head(20)
alldata_GDP_bot20 <- alldata_GDP %>% tail(20)
alldata_GDP_40 <- bind_rows(alldata_GDP_top20, alldata_GDP_bot20)

colors <- alldata_GDP_40$color[order(alldata_GDP_40$GDP_USD_2018)]

GDP_country_point <- ggplot(data = alldata_GDP_40, 
                            aes(x = log(GDP_USD_2018), 
                                y = fct_reorder(country, GDP_USD_2018), 
                                color = US)) +
  geom_point() +
  scale_color_manual(values = c("US" = "#FF0000", "Non US" = "#5BBCD6")) +
  theme(axis.text.y = element_text(color = colors)) +
  guides(color = FALSE) +
  xlab("log(Gross Domestic Product)") +
  ylab("Country") +
  ggtitle("Figure 10.  Gross Domestic Product by Country, Log Transform")
GDP_country_point
```

The United States is not among the top 20 countries in terms of happiness; it ranks 21st (Fig. 11).

```{r WHR_country, echo = FALSE, fig.height = 5, fig.width = 8}
alldata_WHR <- alldata %>%
  filter(!is.na(happiness) == TRUE) %>% 
  arrange(desc(happiness)) %>% 
  select(happiness, country, US, color)

alldata_WHR_top20 <- alldata_WHR %>% head(20)
alldata_WHR_bot20 <- alldata_WHR %>% tail(20)
alldata_WHR_40 <- bind_rows(alldata_WHR_top20, alldata_WHR_bot20)

colors <- alldata_WHR_40$color[order(alldata_WHR_40$happiness)]

WHR_country_point <- ggplot(data = alldata_WHR_40, 
                            aes(x = happiness, y = fct_reorder(country, happiness), color = US)) +
  geom_point() +
  scale_color_manual(values = c("US" = "#FF0000", "Non US" = "#5BBCD6")) +
  theme(axis.text.y = element_text(color = colors)) +
  guides(color = FALSE) +
  xlim(0, 10) +
  xlab("World Happiness Score") +
  ylab("Country") +
  ggtitle("Figure 11.  World Happiness Score by Country")
WHR_country_point
```

```{r WHR_rank, include = TRUE, echo = TRUE}
which(alldata_WHR$country == "United States")
```

Per Fig. 12, the United States ranks twelfth by HDI.

```{r HDI_country, echo = FALSE, fig.height = 5, fig.width = 8}
alldata_HDI <- alldata %>% 
  filter(!is.na(HDIindex) == TRUE) %>% 
  arrange(desc(HDIindex)) %>% 
  select(HDIindex, country, US, color)

alldata_HDI_top20 <- alldata_HDI %>% head(20)
alldata_HDI_bot20 <- alldata_HDI %>% tail(20)
alldata_HDI40 <- bind_rows(alldata_HDI_top20, alldata_HDI_bot20)

colors <- alldata_HDI40$color[order(alldata_HDI40$HDIindex)]

HDI_country_point <- ggplot(data = alldata_HDI40, 
                            aes(x = HDIindex, y = fct_reorder(country, HDIindex), color = US)) +
  geom_point() +
  scale_color_manual(values = c("US" = "#FF0000", "Non US" = "#5BBCD6")) +
  theme(axis.text.y = element_text(color = colors)) +
  guides(color = FALSE) +
  xlim(0, 1) +
  xlab("Human Development Index") +
  ylab("Country") +
  ggtitle("Figure 12.  Human Development Index by Country")
HDI_country_point
```

The United States is not among the top 20 countries in terms of gender equality; it ranks 45th (Fig. 13).

```{r gender_country, echo = FALSE, fig.height = 5, fig.width = 8}
alldata_gender <- alldata %>%
  filter(!is.na(gendereq) == TRUE) %>% 
  arrange(desc(gendereq)) %>% 
  select(gendereq, country, US, color)

alldata_gender_top20 <- alldata_gender %>% head(20)
alldata_gender_bot20 <- alldata_gender %>% tail(20)
alldata_gender_40 <- bind_rows(alldata_gender_top20, alldata_gender_bot20)

colors <- alldata_gender_40$color[order(alldata_gender_40$gendereq)]

gender_country_point <- ggplot(data = alldata_gender_40, 
                            aes(x = gendereq, 
                                y = fct_reorder(country, gendereq), 
                                color = US)) +
  geom_point() +
  scale_color_manual(values = c("US" = "#FF0000", "Non US" = "#5BBCD6")) +
  theme(axis.text.y = element_text(color = colors)) +
  guides(color = FALSE) +
  xlim(0, 1) +
  xlab("Gender Equality Index") +
  ylab("Country") +
  ggtitle("Figure 13.  Gender Equality Index by Country")
gender_country_point
```

```{r gender_rank, include = TRUE, echo = TRUE}
which(alldata_gender$country == "United States")
```

The United States has the world's 46th lowest infant mortality rate (Fig. 14).

```{r infantmort_country, echo = FALSE, fig.height = 5, fig.width = 8}
alldata_infantmort <- alldata %>%
  filter(!is.na(infantmort) == TRUE) %>% 
  arrange(desc(infantmort)) %>% 
  select(infantmort, country, US, color)

alldata_infantmort_top20 <- alldata_infantmort %>% head(20)
alldata_infantmort_bot20 <- alldata_infantmort %>% tail(20)
alldata_infantmort_40 <- bind_rows(alldata_infantmort_top20, alldata_infantmort_bot20)

colors <- alldata_infantmort_40$color[order(alldata_infantmort_40$infantmort)]

infantmort_country_point <- ggplot(data = alldata_infantmort_40, 
                                   aes(x = infantmort, 
                                       y = fct_reorder(country, infantmort), 
                                       color = US)) +
  geom_point() +
  scale_color_manual(values = c("US" = "#FF0000", "Non US" = "#5BBCD6")) +
  theme(axis.text.y = element_text(color = colors)) +
  guides(color = FALSE) +
  xlab("Infant Mortality Rate") +
  ylab("Country") +
  ggtitle("Fig. 14.  Infant Mortality Rate")
infantmort_country_point
```

```{r infantmort_rank, include = TRUE, echo = TRUE}
alldata_infantmort_asc <- alldata_infantmort %>% arrange(infantmort)
which(alldata_infantmort_asc$country == "United States")
```

Finally, per Fig. 15, the United States is not among the top 20 countries for life expectancy, ranking 34th and 31st respectively for life expectancy at birth and at 60 years of age.

```{r lifeexp_country, echo = FALSE, fig.height = 6, fig.width = 12}
alldata_lifeexp <- alldata %>%
  filter(!is.na(birth_MF) == TRUE & !is.na(sixty_MF) == TRUE)

alldata_lifeexp_birth <- alldata_lifeexp %>% 
  arrange(desc(birth_MF)) %>% 
  select(birth_MF, country, US, color)

alldata_lifeexp_birth_top20 <- alldata_lifeexp_birth %>% head(20)
alldata_lifeexp_birth_bot20 <- alldata_lifeexp_birth %>% tail(20)
alldata_lifeexp_birth_40 <- bind_rows(alldata_lifeexp_birth_top20, alldata_lifeexp_birth_bot20)

colors <- alldata_lifeexp_birth_40$color[order(alldata_lifeexp_birth_40$birth_MF)]

birth_MF_country_point <- ggplot(data = alldata_lifeexp_birth_40, 
                            aes(x = birth_MF, 
                                y = fct_reorder(country, birth_MF), 
                                color = US)) +
  geom_point() +
  scale_color_manual(values = c("US" = "#FF0000", "Non US" = "#5BBCD6")) +
  theme(axis.text.y = element_text(color = colors)) +
  guides(color = FALSE) +
  xlim(0, 100) +
  xlab("Total Life Expectancy (years)") +
  ylab("Country") +
  ggtitle("...At Birth")

alldata_lifeexp_sixty <- alldata_lifeexp %>% 
  arrange(desc(sixty_MF)) %>% 
  select(sixty_MF, country, US, color)

alldata_lifeexp_sixty_top20 <- alldata_lifeexp_sixty %>% head(20)
alldata_lifeexp_sixty_bot20 <- alldata_lifeexp_sixty %>% tail(20)
alldata_lifeexp_sixty_40 <- bind_rows(alldata_lifeexp_sixty_top20, alldata_lifeexp_sixty_bot20)

colors <- alldata_lifeexp_sixty_40$color[order(alldata_lifeexp_sixty_40$sixty_MF)]

sixty_MF_country_point <- ggplot(data = alldata_lifeexp_sixty_40, 
                            aes(x = 60 + sixty_MF, 
                                y = fct_reorder(country, sixty_MF), 
                                color = US)) +
  geom_point() +
  scale_color_manual(values = c("US" = "#FF0000", "Non US" = "#5BBCD6")) +
  theme(axis.text.y = element_text(color = colors)) +
  guides(color = FALSE) +
  xlim(0, 100) +
  xlab("Total Life Expectancy (years)") +
  ylab("Country") +
  ggtitle("...At Age 60")

grid.arrange(birth_MF_country_point, sixty_MF_country_point, nrow = 1,
             top = textGrob("Figure 15.  Total Life Expectancy by Country...",
                            gp = gpar(fontsize = 16, fontface = "bold", col = "#545454"),
                            x = 0.025, hjust = 0))
```

```{r lifeexp_ranks, include = TRUE, echo = TRUE}
which(alldata_lifeexp_birth$country == "United States")
which(alldata_lifeexp_sixty$country == "United States")
```

Per the above country-level analyses, the United States was not among the top 20 performing countries for happiness, gender equality, infant mortality, and life expectancy at birth and at 60 years, thus these five fields were examined via clustering.


### *Clustering Analysis*

Ten pairwise cluster analyses were performed assuming $k = 4$ clusters, shown in Table 4.

**Table 4.  Cluster Analyses Considered**

| **Cluster Analysis** 	| **Variables**             	|
|----------------------	|---------------------------	|
| 1                    	| `happiness`, `gendereq`   	|
| 2                    	| `happiness`, `infantmort` 	|
| 3                    	| `happiness`, `birth_MF`   	|
| 4                    	| `happiness`, `sixty_MF`   	|
| 5                    	| `gendereq`, `infantmort`  	|
| 6                    	| `gendereq`, `birth_MF`    	|
| 7                    	| `gendereq`, `sixty_MF`    	|
| 8                    	| `infantmort`, `birth_MF`  	|
| 9                    	| `infantmort`, `sixty_MF`  	|
| 10                   	| `birth_MF`, `sixty_MF`    	|

```{r NAomit, include = FALSE, echo = FALSE, eval = TRUE}
clusterdata <- alldata %>%
  na.omit()

# write_csv(clusterdata, paste0("data/clusterdata_", lubridate::today(),".csv"))  # Uncomment to export clustering dataset
```

```{r kmeans_fxn, echo = FALSE, eval = TRUE}
kmdf <- function(data, x, y, z){
  kmdata <- data %>% 
    select(x, y, z)
  kmdata <- return(kmdata)
}
```

For Cluster Analysis #1 (Fig. 16) considering `happiness` and `gendereq`, the United States was clustered with other highly-developed nations; this remained stable when testing $k = 3$ and $k = 5$ clusters.

```{r kmeans_happiness_gendereq, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 8, fig.height = 4}
kmdata <- kmdf(clusterdata, "country", "happiness", "gendereq")

set.seed(19811221)
km_subset <- kmeans(kmdata[, 2:3], 4)
km_subset_cluster <- as.factor(km_subset$cluster)

clusterdata1 <- cbind(clusterdata, km_subset_cluster)

km_happiness_gendereq_plot <- ggplot(data = clusterdata1,
                                     aes(x = happiness, y = gendereq, 
                                         color = km_subset_cluster,
                                         size = US,
                                         shape = HDI_cat)) +
  geom_point() +
  scale_color_manual(values = wes) +
  scale_shape_manual(values = c(18, 17, 15, 16)) +
  guides(color = guide_legend(title = "Cluster"), 
         size = FALSE, 
         shape = guide_legend(reverse = TRUE, title = "HDI Category")) +
  xlab("Happiness Score") +
  ylab("Gender Equality Index") +
  ggtitle("Figure 16.  Cluster Analysis, Gender Equality Index vs. Happiness Score")
km_happiness_gendereq_plot
```

Figure 17 depicts Cluster Analysis #2 for happiness score vs. infant mortality rate.  The United States was again clustered with other highly-developed nations, and remained so when testing $k = 3$ and $k = 5$ clusters.

```{r kmeans_happiness_infantmort, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 8, fig.height = 4}
kmdata <- kmdf(clusterdata, "country", "happiness", "infantmort")

set.seed(19811221)
km_subset <- kmeans(kmdata[, 2:3], 4)
km_subset_cluster <- as.factor(km_subset$cluster)

clusterdata1 <- cbind(clusterdata, km_subset_cluster)

km_happiness_infantmort_plot <- ggplot(data = clusterdata1,
                                     aes(x = happiness, y = infantmort, 
                                         color = km_subset_cluster,
                                         size = US,
                                         shape = HDI_cat)) +
  geom_point() +
  scale_color_manual(values = wes) +
  scale_shape_manual(values = c(18, 17, 15, 16)) +
  guides(color = guide_legend(title = "Cluster"), 
         size = FALSE, 
         shape = guide_legend(reverse = TRUE, title = "HDI Category")) +
  xlab("Happiness Score") +
  ylab("Infant Mortality Rate") +
  ggtitle("Figure 17.  Cluster Analysis, Infant Mortality Rate vs. Happiness Score")
km_happiness_infantmort_plot
```

Cluster Analyses 3 and 4 (Fig. 18) compared happiness score to both life expectancy variables.  The US was clustered with other highly developed nations when considering total life expectancy at age 60, but for total life expectancy at birth, the US occupied a mixed cluster containing some countries at the "very high" development level, and some at the "high" level.  For total life expectancy at age 60, the results were stable when testing $k = 3$ and $k = 5$ clusters; however, for life expectancy at birth, the US entered the cluster dominated by "very high"-level countries at $k = 3$.

```{r kmeans_happiness_lifeexp, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 10, fig.height = 8}
kmdata <- kmdf(clusterdata, "country", "happiness", "birth_MF")

set.seed(19811221)
km_subset <- kmeans(kmdata[, 2:3], 4)
km_subset_cluster <- as.factor(km_subset$cluster)

clusterdata1 <- cbind(clusterdata, km_subset_cluster)

km_happiness_birth_MF_plot <- ggplot(data = clusterdata1,
                                     aes(x = happiness, y = birth_MF, 
                                         color = km_subset_cluster,
                                         size = US,
                                         shape = HDI_cat)) +
  geom_point() +
  scale_color_manual(values = wes) +
  scale_shape_manual(values = c(18, 17, 15, 16)) +
  xlim(min(clusterdata1$happiness) * 0.9, max(clusterdata1$happiness) * 1.1) +
  ylim(50, 90) +
  guides(color = FALSE, size = FALSE, shape = FALSE) +
  xlab("Happiness Score") +
  ylab("Total Life Expectancy at Birth (years)") +
  ggtitle("...at Birth")

kmdata <- kmdf(clusterdata, "country", "happiness", "sixty_MF")

set.seed(19811221)
km_subset <- kmeans(kmdata[, 2:3], 4)
km_subset_cluster <- as.factor(km_subset$cluster)

clusterdata1 <- cbind(clusterdata, km_subset_cluster)

km_happiness_sixty_MF_plot <- ggplot(data = clusterdata1,
                                     aes(x = happiness, y = 60 + sixty_MF, 
                                         color = km_subset_cluster,
                                         size = US,
                                         shape = HDI_cat)) +
  geom_point() +
  scale_color_manual(values = wes) +
  scale_shape_manual(values = c(18, 17, 15, 16)) +
  xlim(min(clusterdata1$happiness) * 0.9, max(clusterdata1$happiness) * 1.1) +
  ylim(50, 90) +
  guides(color = guide_legend(title = "Cluster"), 
         size = FALSE, 
         shape = guide_legend(reverse = TRUE, title = "HDI Category")) +
  theme(legend.position = "bottom") +
  xlab("Happiness Score") +
  ylab("Total Life Expectancy at Age 60 (years)") +
  ggtitle("...at Age 60")

grid.arrange(km_happiness_birth_MF_plot, km_happiness_sixty_MF_plot, nrow = 2,
             top = textGrob("Figure 18.  Cluster Analysis, Happiness Score vs. Total Life Expectancy...",
                            gp = gpar(fontsize = 16, fontface = "bold", col = "#545454"),
                            x = 0.025, hjust = 0))
```

Figure 19 presents Cluster Analysis #5.  The US occupied a mixed cluster including countries from all HDI categories, and this did not change with varying *k*.

```{r kmeans_gendereq_infantmort, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 8, fig.height = 4}
kmdata <- kmdf(clusterdata, "country", "gendereq", "infantmort")

set.seed(19811221)
km_subset <- kmeans(kmdata[, 2:3], 4)
km_subset_cluster <- as.factor(km_subset$cluster)

clusterdata1 <- cbind(clusterdata, km_subset_cluster)

km_gendereq_infantmort_plot <- ggplot(data = clusterdata1,
                                     aes(x = gendereq, y = infantmort, 
                                         color = km_subset_cluster,
                                         size = US,
                                         shape = HDI_cat)) +
  geom_point() +
  scale_color_manual(values = wes) +
  scale_shape_manual(values = c(18, 17, 15, 16)) +
  guides(color = guide_legend(title = "Cluster"), 
         size = FALSE, 
         shape = guide_legend(reverse = TRUE, title = "HDI Category")) +
  xlab("Gender Equality Index") +
  ylab("Infant Mortality Rate") +
  ggtitle("Figure 19.  Cluster Analysis, Infant Mortality Rate vs. Gender Equality Index")
km_gendereq_infantmort_plot
```

Figure 20 depicts Cluster Analyses 6 and 7, and Figure 21 shows Cluster Analyses 8 and 9.  For both of these sets of analyses, the US was differentially clustered in the same manner as described for Cluster Analyses 3 and 4, and also had the same sensitivity to changing *k* as seen in those analyses.  These results indicate that total life expectancy at birth is predictive of cluster number to some degree.

```{r kmeans_gendereq_lifeexp, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 10, fig.height = 8}
kmdata <- kmdf(clusterdata, "country", "gendereq", "birth_MF")

set.seed(19811221)
km_subset <- kmeans(kmdata[, 2:3], 4)
km_subset_cluster <- as.factor(km_subset$cluster)

clusterdata1 <- cbind(clusterdata, km_subset_cluster)

km_gendereq_birth_MF_plot <- ggplot(data = clusterdata1,
                                     aes(x = gendereq, y = birth_MF, 
                                         color = km_subset_cluster,
                                         size = US,
                                         shape = HDI_cat)) +
  geom_point() +
  scale_color_manual(values = wes) +
  scale_shape_manual(values = c(18, 17, 15, 16)) +
  xlim(min(clusterdata1$gendereq) * 0.9, max(clusterdata1$gendereq) * 1.1) +
  ylim(50, 90) +
  guides(color = FALSE, size = FALSE, shape = FALSE) +
  xlab("Gender Equality Index") +
  ylab("Total Life Expectancy at Birth (years)") +
  ggtitle("...at Birth")

kmdata <- kmdf(clusterdata, "country", "happiness", "sixty_MF")

set.seed(19811221)
km_subset <- kmeans(kmdata[, 2:3], 4)
km_subset_cluster <- as.factor(km_subset$cluster)

clusterdata1 <- cbind(clusterdata, km_subset_cluster)

km_gendereq_sixty_MF_plot <- ggplot(data = clusterdata1,
                                    aes(x = gendereq, y = 60 + sixty_MF,
                                        color = km_subset_cluster,
                                        size = US,
                                        shape = HDI_cat)) +
  geom_point() +
  scale_color_manual(values = wes) +
  scale_shape_manual(values = c(18, 17, 15, 16)) +
  xlim(min(clusterdata1$gendereq) * 0.9, max(clusterdata1$gendereq) * 1.1) +
  ylim(50, 90) +
  guides(color = guide_legend(title = "Cluster"),
         size = FALSE,
         shape = guide_legend(reverse = TRUE, title = "HDI Category")) +
  theme(legend.position = "bottom") +
  xlab("Gender Equality Index") +
  ylab("Total Life Expectancy at Age 60 (years)") +
  ggtitle("...at Age 60")

grid.arrange(km_gendereq_birth_MF_plot, km_gendereq_sixty_MF_plot, nrow = 2,
             top = textGrob("Figure 20.  Cluster Analysis, Gender Equality Index vs. Total Life Expectancy...",
                            gp = gpar(fontsize = 16, fontface = "bold", col = "#545454"),
                            x = 0.025, hjust = 0))
```

```{r kmeans_infantmort_lifeexp, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 10, fig.height = 8}
kmdata <- kmdf(clusterdata, "country", "infantmort", "birth_MF")

set.seed(19811221)
km_subset <- kmeans(kmdata[, 2:3], 4)
km_subset_cluster <- as.factor(km_subset$cluster)

clusterdata1 <- cbind(clusterdata, km_subset_cluster)

km_infantmort_birth_MF_plot <- ggplot(data = clusterdata1,
                                     aes(x = infantmort, y = birth_MF, 
                                         color = km_subset_cluster,
                                         size = US,
                                         shape = HDI_cat)) +
  geom_point() +
  scale_color_manual(values = wes) +
  scale_shape_manual(values = c(18, 17, 15, 16)) +
  xlim(0, 0.1) +
  ylim(50, 90) +
  guides(color = FALSE, size = FALSE, shape = FALSE) +
  xlab("Infant Mortality Rate") +
  ylab("Total Life Expectancy at Birth (years)") +
  ggtitle("...at Birth")

kmdata <- kmdf(clusterdata, "country", "happiness", "sixty_MF")

set.seed(19811221)
km_subset <- kmeans(kmdata[, 2:3], 4)
km_subset_cluster <- as.factor(km_subset$cluster)

clusterdata1 <- cbind(clusterdata, km_subset_cluster)

km_infantmort_sixty_MF_plot <- ggplot(data = clusterdata1,
                                    aes(x = infantmort, y = 60 + sixty_MF, 
                                        color = km_subset_cluster,
                                        size = US,
                                        shape = HDI_cat)) +
  geom_point() +
  scale_color_manual(values = wes) +
  scale_shape_manual(values = c(18, 17, 15, 16)) +
  xlim(0, 0.1) +
  ylim(50, 90) +
  guides(color = guide_legend(title = "Cluster"), 
         size = FALSE, 
         shape = guide_legend(reverse = TRUE, title = "HDI Category")) +
  theme(legend.position = "bottom") +
  xlab("Infant Mortality Rate") +
  ylab("Total Life Expectancy at Age 60 (years)") +
  ggtitle("...at Age 60")

grid.arrange(km_infantmort_birth_MF_plot, km_infantmort_sixty_MF_plot, nrow = 2,
             top = textGrob("Figure 21.  Cluster Analysis, Infant Mortality Rate vs. Total Life Expectancy...",
                            gp = gpar(fontsize = 16, fontface = "bold", col = "#545454"),
                            x = 0.025, hjust = 0))
```

Finally, Fig. 22 shows Cluster Analysis #10.  The United States was again found in a mixed cluster, containing countries in the medium, high, and very high HDI categories.  US cluster position remained unchanged for $k = 5$, but for $k = 3$, the US moved to the first cluster, containing mostly countries in the very high HDI category.

```{r kmeans_birth_MF_sixty_MF, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 8, fig.height = 4}
kmdata <- kmdf(clusterdata, "country", "birth_MF", "sixty_MF")

set.seed(19811221)
km_subset <- kmeans(kmdata[, 2:3], 4)
km_subset_cluster <- as.factor(km_subset$cluster)

clusterdata1 <- cbind(clusterdata, km_subset_cluster)

km_birth_MF_sixty_MF_plot <- ggplot(data = clusterdata1,
                                     aes(x = birth_MF, y = 60 + sixty_MF, 
                                         color = km_subset_cluster,
                                         size = US,
                                         shape = HDI_cat)) +
  geom_point() +
  scale_color_manual(values = wes) +
  scale_shape_manual(values = c(18, 17, 15, 16)) +
  guides(color = guide_legend(title = "Cluster"), 
         size = FALSE, 
         shape = guide_legend(reverse = TRUE, title = "HDI Category")) +
  xlab("Total Life Expectancy at Birth (years)") +
  ylab("Total Life Expectancy at Age 60 (years)") +
  ggtitle("Figure 22.  Cluster Analysis, Total Life Expectancy at Age 60 vs. at Birth")
km_birth_MF_sixty_MF_plot
```


## **Discussion**

This study is useful in understanding some of the ways in which the United States lags behind other countries having a similar level of development.  The US has the world's largest GDP, but this study shows that quality of life measures do not necessarily correspond to national wealth.  Of the 8 continuous QoL variables considered, the United States did not appear within the top 20 performing countries for 5 (62.5%):  happiness score, gender equality index, infant mortality rate, and the two total life expectancy variables.  On clustering analysis, the US often clustered with countries of lower developmental level by HDI, particularly when considering total life expectancy at birth, and in some cases, these results remained stable when varying cluster number.  These findings help pinpoint the ways in which the US underperforms.


### *Limitations*

There are several limitations to this study.  Missing data presented a challenge:  countries with incomplete data were omitted for the clustering analysis, reducing the dataset from $n = 205$ to $n = 111$ countries.  Several of the omitted countries were of low-to-medium developmental level, and omitting these may bias the results of the analysis.  Second, several of these variables appear interrelated.  For example, a strong correlation between `HDIindex` and `SPI` was seen in Fig. 8.  These are compound measures calculated by different agencies, and there is some intersection in the subitems they each include.  This correlation limits the usefulness of these two variables.  Finally, limiting the data to 2016 prevents the ability to perform a longitudinal analysis.  While countries in the "very high" HDI category are likely to be stable or slow-changing in QoL measures, developing countries or those with political instability may be more volatile, and these changes could be analyzed if data were present for even as short a time period as a decade.


### *Surprises and Challenges*

Given that clustering considered the subset of variables for which the United States did not rank within the top 20 countries, the most surprising finding is that, for some of the cluster analyses, the US was classified with other countries in the "very high" HDI category, and these findings remained stable when varying *k*.  Specific examples are gender equality index vs. happiness score (Fig. 16) and infant mortality rate vs. happiness score (Fig. 17).

The major technical challenge in this study was the data wrangling step:  though not particularly difficult, it was time-consuming, and the manual country name recoding was tedious.  In an attempt to partially automate matching on country name, fuzzy matching was attempted, but performance was poor, and I was unable to find a way to fuzzy-match by varying both string length and character distance.  For example, matching the strings "Trinidad and Tobago" and "Trinidad & Tobago" would require matching with fuzzy string length (the first string is 2 characters longer than the second) whereas the strings "Cabo Verde" and "Cape Verde" would require matching with fuzzy character distance ("ca**bo**" vs. "ca**pe**").  The other challenge in this study is interpretive:  the clustering visualizations contain the relevant results, but are not intuitive to interpret.  The shapes given by the `shape` aesthetic are difficult to differentiate when using small shapes, but larger shapes obscure results due to overlapping, and it would not be appropriate to use jittering to avoid overlapping when visualizing cluster analyses.


### *Future Directions*

Future work should include bringing additional years of data into the dataset and performing a longitudinal analysis.  Additionally, since there is concern about both life expectancy and infant mortality rate in the US, relevant single-item QoL measures and epidemiological data should be incorporated to inform robust linear models aimed at predicting infant mortality rate and life expectancy.  These analyses could be useful in informing policy decisions about public health and health education.


## **Conclusion**

Though the United States has the world's largest economy, it underperforms on several key QoL measures.  *K*-means clustering provides a powerful tool for investigating these deficits, and clustering results can help shape future research and public policy.


## **References**