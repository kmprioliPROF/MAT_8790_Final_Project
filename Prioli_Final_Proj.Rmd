---
title: "Quality of Life by Country:  A Clustering Analysis"
author: "Katherine M. Prioli"
date: "December 22, 2018"
output:
  pdf_document: default
  html_document: default
geometry: margin = 0.5in
references:
- URL: https://github.com/kmprioliPROF/MAT_8790_Final_Project
  author:
  - family: Prioli
    given: Katherine M.
  id: kmpgit
  issued:
    month: 12
    year: 2018
  title: MAT_8790_Final_Project
- URL: http://apps.who.int/gho/data/view.main.SDG2016LEXv?lang=en
  author:
  - family: WHO
  id: who_life
  issued:
    year: 2018
  title: Life Expectancy
- URL: http://apps.who.int/gho/data/view.main.182?lang=en
  author:
  - family: WHO
  id: who_infantmort
  issued:
    year: 2018
  title: Probability of Dying per 1000 Live Births
- URL: http://reports.weforum.org/global-gender-gap-report-2016/rankings/
  author:
  - family: WEF
  id: wef_gender
  issued:
    year: 2016
  title: Gender Equality
- URL: https://data.worldbank.org/indicator/ny.gdp.mktp.cd?view=map&year_high_desc=true 
  author:
  - family: The World Bank
  id: worldbank_gdp
  issued:
    year: 2018
  title: Gross Domestic Product
- URL: http://hdr.undp.org/en/data
  author:
  - family: The United Nations Development Programme
  id: un_dvlpt
  issued:
    year: 2018
  title: Human Development Index
- URL: https://www.socialprogress.org/?tab=4
  author:
  - family: Social Progress Imperative
  id: socialprog
  issued:
    year: 2018
  title: Social Progress Index
- URL: http://worldhappiness.report/ed/2018/
  author:
  - family: World Happiness Report
  id: whr
  issued:
    year: 2018
  title: World Happiness Report
---

## **Background**



## **Methods**

<!-- Notes
  * Limited dataset to 2016, except for OECD income inequality data, which was most complete for 2015
  * May want to explain methods & show one example for each import/wrangle/test against countries, then hide code for the rest, indicating that full code is either in appendix or on github (will make report too long otherwise)
  * Clustering:  in Shiny app, write code to display "The United States is in " _fill in the blank_ "cluster"
  * Need to better organize flow of report (some results are in Methods, etc)
  * Need to more fully narrate steps and interpretations of output
  
  * Limitations:

  -->


### *Loading libraries*

```{r setup, include = TRUE, warning = FALSE, results = 'hide', echo = TRUE, message = FALSE}
library(tidyverse)
library(readxl)          # For importing .xls(x) datasets
library(lazyeval)        # For renaming columns in function
library(countrycode)     # For establishing uniform country identifiers
library(ggthemr)         # For prettifying output
library(gridExtra)       # For grid.arrange()
library(grid)            # For textGrob() to annotate grid.arrange() elements
library(kableExtra)      # For nicer output tables
library(GGally)          # For ggpairs() correlation matrix

ggthemr("fresh")
```

### *Establishing a crosswalk for country names and 3-letter codes*

```{r countries, include = TRUE, echo = TRUE, eval = TRUE}
countries_full <- codelist_panel %>% 
  select(country.name.en, year, genc3c, iso3c, wb_api3c) %>% 
  group_by(country.name.en) %>% 
  mutate(maxyr = max(year)) %>% 
  ungroup %>% 
  mutate(maxyr = case_when(
    maxyr == year ~ 1,
    TRUE ~ 0
  )) %>% 
  filter(maxyr == 1) %>% 
  select(-maxyr) %>% 
  distinct()

countries_full <- countries_full %>% 
  mutate(country3 = case_when(
    iso3c == genc3c & iso3c == wb_api3c ~ iso3c,
    is.na(iso3c) == FALSE ~ iso3c,
    is.na(iso3c) == TRUE & is.na(genc3c) == FALSE ~ genc3c,
    is.na(iso3c) == TRUE & is.na(genc3c) == TRUE & is.na(wb_api3c) == FALSE ~ wb_api3c
  )) %>% 
  rename(country = country.name.en) %>% 
  arrange(country)
  
countries <- countries_full %>% 
  select(country, country3)
```

### *Importing and wrangling each data file, and standardizing country names*

Each datafile was imported and wrangled to subset to the variable(s) of interest for 2016.  Next, country identifiers in each dataset were compared to the `countries` table, and a `mutate()` statement was used to correct mismatches.  In the interest of brevity, these steps are demonstrated for the Human Development Index (HDI) data below.

First, importing and wrangling the HDI data:

```{r HDI_import, include = TRUE, echo = TRUE, eval = TRUE, message = FALSE, warning = FALSE}

# Importing raw data

HDIraw <- read_xlsx("data/HDIdata2018.xlsx", sheet = "Table 2")
HDIraw

# Selecting columns of interest

HDIdata <- HDIraw %>%
  select(1:2, X__14)

# Assigning sensible column names

HDIcolnm <- c(HDIdata[[3,1]], HDIdata[[3,2]], HDIdata[[4,3]])
colnames(HDIdata) <- HDIcolnm

# Determining boundaries for human development levels in the data
# and using these to create one dataframe for each level

vhhd_st <- which(HDIdata$Country == "VERY HIGH HUMAN DEVELOPMENT") + 1
vhhd_end <- which(HDIdata$Country == "HIGH HUMAN DEVELOPMENT") - 1

hhd_st <- which(HDIdata$Country == "HIGH HUMAN DEVELOPMENT") + 1
hhd_end <- which(HDIdata$Country == "MEDIUM HUMAN DEVELOPMENT") - 1

mhd_st <- which(HDIdata$Country == "MEDIUM HUMAN DEVELOPMENT") + 1
mhd_end <- which(HDIdata$Country == "LOW HUMAN DEVELOPMENT") - 1

lhd_st <- which(HDIdata$Country == "LOW HUMAN DEVELOPMENT") + 1
lhd_end <- which(HDIdata$Country == "OTHER COUNTRIES OR TERRITORIES") - 1

oth_st <- which(HDIdata$Country == "OTHER COUNTRIES OR TERRITORIES") + 1
oth_end <- which(HDIdata$Country == "Human development groups") - 2

HDI_vhhd <- HDIdata %>% 
  slice(vhhd_st:vhhd_end) %>% 
  mutate(HDI_cat = "Very High")

HDI_hhd <- HDIdata %>% 
  slice(hhd_st:hhd_end) %>% 
  mutate(HDI_cat = "High")

HDI_mhd <- HDIdata %>% 
  slice(mhd_st:mhd_end) %>% 
  mutate(HDI_cat = "Medium")

HDI_lhd <- HDIdata %>% 
  slice(lhd_st:lhd_end) %>% 
  mutate(HDI_cat = "Low")

HDI_oth <- HDIdata %>% 
  slice(oth_st:oth_end) %>% 
  mutate(HDI_cat = NA)

# Combining the dataframes into one 

HDIdata <- bind_rows(HDI_vhhd, HDI_hhd, HDI_mhd, HDI_lhd, HDI_oth) %>% 
  rename(HDIrank = `HDI rank`) %>% 
  rename(country = Country) %>% 
  rename(HDIindex = `2016`) %>% 
  mutate(HDI_cat = factor(HDI_cat, levels = c("Low", "Medium", "High", "Very High"))) %>% 
  mutate(HDIrank = case_when(
    HDIrank == ".." ~ as.numeric(NA),
    TRUE ~ as.numeric(HDIrank)
  )) %>% 
  mutate(HDIindex = case_when(
    HDIindex == ".." ~ as.numeric(NA),
    TRUE ~ as.numeric(HDIindex)
  ))
HDIdata <- HDIdata[c(2, 1, 3:4)]
```

Next, standardizing country names by using `anti_join()` to see which countries in `HDIdata` don't have a match in the `countries` dataframe, and correcting those for which an inexact match exists:

```{r HDI_countrytest, include = TRUE, echo = TRUE, eval = TRUE}
HDIanti <- HDIdata %>%
  anti_join(countries, by = "country") %>%
  select(country) %>%
  arrange(country)
dim(HDIanti)
```

There are `r dim(HDIanti)[[1]]` countries in `HDIdata` without an exact match in `countries`.  Correcting using `mutate()`:

```{r HDI_countryfix, include = TRUE, echo = TRUE, eval = TRUE}

HDIdata <- HDIdata %>%
  mutate(country = case_when(
    country == "Antigua and Barbuda"                       ~ "Antigua & Barbuda",
    country == "Bolivia (Plurinational State of)"          ~ "Bolivia",
    country == "Bosnia and Herzegovina"                    ~ "Bosnia & Herzegovina",
    country == "Brunei Darussalam"                         ~ "Brunei",
    country == "Cabo Verde"                                ~ "Cape Verde",
    country == "Congo"                                     ~ "Congo - Brazzaville",
    country == "Congo (Democratic Republic of the)"        ~ "Congo - Kinshasa",
    country == "Eswatini (Kingdom of)"                     ~ "Swaziland",
    country == "Hong Kong, China (SAR)"                    ~ "Hong Kong SAR China",
    country == "Iran (Islamic Republic of)"                ~ "Iran",
    country == "Korea (Democratic People's Rep. of)"       ~ "North Korea",
    country == "Korea (Republic of)"                       ~ "South Korea",
    country == "Lao People's Democratic Republic"          ~ "Laos",
    country == "Moldova (Republic of)"                     ~ "Moldova",
    country == "Myanmar"                                   ~ "Myanmar (Burma)",
    country == "Palestine, State of"                       ~ "Palestinian Territories",
    country == "Russian Federation"                        ~ "Russia",
    country == "Saint Kitts and Nevis"                     ~ "St. Kitts & Nevis",
    country == "Saint Lucia"                               ~ "St. Lucia",
    country == "Saint Vincent and the Grenadines"          ~ "St. Vincent & Grenadines",
    country == "Syrian Arab Republic"                      ~ "Syria",
    country == "Tanzania (United Republic of)"             ~ "Tanzania",
    country == "The former Yugoslav Republic of Macedonia" ~ "Macedonia",
    country == "Trinidad and Tobago"                       ~ "Trinidad & Tobago",
    country == "Venezuela (Bolivarian Republic of)"        ~ "Venezuela",
    country == "Viet Nam"                                  ~ "Vietnam",
    country == "CÃ´te d'Ivoire"                             ~ as.character(NA),   # UTC-8
    country == "Sao Tome and Principe"                     ~ as.character(NA),   # conflicts
    TRUE                                                   ~ as.character(country)
  )) %>% 
  filter(!is.na(country))

HDIanti <- HDIdata %>%
  anti_join(countries, by = "country") %>%
  select(country) %>%
  arrange(country)
dim(HDIanti)
```

Now there are no countries in `HDIdata` without an exact match in `countries`.

```{r HDI_cleanup, include = FALSE, echo = FALSE, eval = TRUE}
rm(list = c("hhd_end", "hhd_st", "lhd_end", "lhd_st", "mhd_end", "mhd_st", "oth_end", "oth_st", "vhhd_end",
            "vhhd_st", "HDIraw", "HDIcolnm", "HDI_vhhd", "HDI_hhd", "HDI_mhd", "HDI_lhd", "HDI_oth", "HDIanti"))
```

<!-- Social Progress Index (SPI) data: -->

```{r SPI_import, include = FALSE, echo = FALSE, eval = TRUE}
SPI_2016_raw <- read_xlsx("data/SPIdata.xlsx", sheet = 4)

SPIdata <- SPI_2016_raw %>% 
  select(2:3) %>% 
  rename(`SPI` = `Social Progress Index`,
         country3 = Code)
```

<!-- Testing against `countries` and renaming to correct for conflicts: -->

```{r SPI_countrytest, include = FALSE, echo = FALSE, eval = TRUE}
SPIanti <- SPIdata %>%
  anti_join(countries, by = "country3") %>%
  select(country3) %>%
  arrange(country3) %>% 
  unique()
dim(SPIanti)

SPIdata <- SPIdata %>%
  mutate(country3 = case_when(
    country3 == "CHI" ~ as.character(NA), # Nonstandard code for Chile; omitting (no data in these rows)
    country3 == "KSV" ~ "XKS",            # Nonstandard code for Kosovo
    country3 == "NCY" ~ as.character(NA), # Turk. Repub. of N. Cyprus; omitting (conflict w/Cyprus)
    country3 == "SML" ~ as.character(NA), # Unable to determine
    country3 == "WBG" ~ as.character(NA), # West Bank / Gaza Strip; omitting (conflict w/Palestine)
    TRUE ~ as.character(country3)
  )) %>% 
  filter(!is.na(country3))

SPIanti <- SPIdata %>%
  anti_join(countries, by = "country3") %>%
  select(country3) %>%
  arrange(country3) %>% 
  unique()
dim(SPIanti)

# Removing unneeded files

rm(list = c("SPI_2016_raw", "SPIanti"))
```

<!-- World Happiness Score data: -->

```{r WHRdata_import, include = FALSE, echo = FALSE, eval = TRUE}
WHR_raw <- read_xls("data/WHRdata.xls", sheet = 1)
WHRdata <- WHR_raw %>% 
  select(1:3) %>% 
  rename(happiness = `Life Ladder`) %>% 
  filter(year == 2016) %>% 
  select(-year)
```

<!-- Testing against `countries` and correcting for conflicts: -->

```{r WHR_countrytest, include = FALSE, echo = FALSE, eval = TRUE}
WHRanti <- WHRdata %>%
  anti_join(countries, by = "country") %>%
  select(country) %>%
  arrange(country) %>% 
  unique()
dim(WHRanti)

WHRdata <- WHRdata %>% 
  mutate(country = case_when(
    country == "Bosnia and Herzegovina"                    ~ "Bosnia & Herzegovina",
    country == "Congo (Brazzaville)"                       ~ "Congo - Brazzaville",
    country == "Congo (Kinshasa)"                          ~ "Congo - Kinshasa",
    country == "Czech Republic"                            ~ "Czechia",
    country == "Hong Kong S.A.R. of China"                 ~ "Hong Kong SAR China",
    country == "Myanmar"                                   ~ "Myanmar (Burma)",
    country == "Taiwan Province of China"                  ~ "Taiwan",
    country == "Trinidad and Tobago"                       ~ "Trinidad & Tobago",
    country == "North Cyprus"                              ~ as.character(NA),   # conflicts w/Cyprus
    country == "Ivory Coast"                               ~ as.character(NA),   # UTC-8 conflicts;
    TRUE                                                   ~ as.character(country)
  )) %>% 
  filter(!is.na(country))

WHRanti <- WHRdata %>%
  anti_join(countries, by = "country") %>%
  select(country) %>%
  arrange(country) %>% 
  unique()
dim(WHRanti)

# Removing unneeded files

rm(list = c("WHR_raw", "WHRanti"))
```

<!-- World Economic Forum Gender Equality Index data: -->

```{r gender_import, include = FALSE, echo = FALSE, eval = TRUE}
gender_raw <- read_xlsx("data/WEF_gender.xlsx", sheet = 2, range = "$A$2:$K$147")
gender_raw <- gender_raw %>% 
  select(1:2)
colnames(gender_raw) <- c("country", "genderequality_index")
genderdata <- gender_raw %>% 
  slice(2:dim(gender_raw)[1]) %>% 
  mutate(genderequality_index = as.numeric(genderequality_index))
```

<!-- Testing against `countries` and correcting for conflicts: -->

```{r gender_countrytest, include = FALSE, echo = FALSE, eval = TRUE}
genderanti <- genderdata %>%
  anti_join(countries, by = "country") %>%
  select(country) %>%
  arrange(country) %>% 
  unique()
dim(genderanti)

genderdata <- genderdata %>%
  mutate(country = case_when(
    country == "Bosnia and Herzegovina"                    ~ "Bosnia & Herzegovina",
    country == "Brunei Darussalam"                         ~ "Brunei",
    country == "Czech Republic"                            ~ "Czechia",
    country == "Gambia, The"                               ~ "Gambia",
    country == "Iran, Islamic Rep."                        ~ "Iran",
    country == "Korea, Rep."                               ~ "South Korea",
    country == "Kyrgyz Republic"                           ~ "Kyrgyzstan",
    country == "Lao PDR"                                   ~ "Laos",
    country == "Macedonia, FYR"                            ~ "Macedonia",
    country == "Russian Federation"                        ~ "Russia",
    country == "Slovak Republic"                           ~ "Slovakia",
    country == "Trinidad and Tobago"                       ~ "Trinidad & Tobago",
    country == "CÃ´te d'Ivoire"                             ~ as.character(NA),   # UTC-8 conflict
    TRUE                                                   ~ as.character(country)
  )) %>% 
  filter(!is.na(country))

genderanti <- genderdata %>%
  anti_join(countries, by = "country") %>%
  select(country) %>%
  arrange(country) %>% 
  unique()
dim(genderanti)

# Removing unneeded files

rm(list = c("gender_raw", "genderanti"))
```

<!-- World Health Organization infant mortality rate data: -->

```{r infantmort_import, include = FALSE, echo = FALSE, eval = TRUE}
infantmort_raw <- read_csv("data/WHO_infantmort.csv")
infantmortdata <- infantmort_raw %>% 
  select(1, 3) %>% 
  rename(country = Country) %>% 
  rename(infantmort = `Infant mortality rate (probability of dying between birth and age 1 per 1000 live births)`) %>% 
  mutate(infantmort = as.numeric(infantmort) / 1000)
```

<!-- Testing against `countries` and correcting for conflicts: -->

```{r infantmort_countrytest, include = FALSE, echo = FALSE, eval = TRUE}
infantmortanti <- infantmortdata %>%
  anti_join(countries, by = "country") %>%
  select(country) %>%
  arrange(country) %>% 
  unique()
dim(infantmortanti)

infantmortdata <- infantmortdata %>% 
  mutate(country = case_when(
    country == "Antigua and Barbuda"                                  ~ "Antigua & Barbuda",
    country == "Bolivia (Plurinational State of)"                     ~ "Bolivia",
    country == "Bosnia and Herzegovina"                               ~ "Bosnia & Herzegovina",
    country == "Brunei Darussalam"                                    ~ "Brunei",
    country == "Cabo Verde"                                           ~ "Cape Verde",
    country == "Congo"                                                ~ "Congo - Brazzaville",
    country == "Democratic People's Republic of Korea"                ~ "North Korea",
    country == "Democratic Republic of the Congo"                     ~ "Congo - Kinshasa",
    country == "Eswatini"                                             ~ "Swaziland",
    country == "Iran (Islamic Republic of)"                           ~ "Iran",
    country == "Lao People's Democratic Republic"                     ~ "Laos",
    country == "Myanmar"                                              ~ "Myanmar (Burma)",
    country == "Republic of Korea"                                    ~ "South Korea",
    country == "Republic of Moldova"                                  ~ "Moldova",
    country == "Russian Federation"                                   ~ "Russia",
    country == "Saint Kitts and Nevis"                                ~ "St. Kitts & Nevis",
    country == "Saint Lucia"                                          ~ "St. Lucia",
    country == "Saint Vincent and the Grenadines"                     ~ "St. Vincent & Grenadines",
    country == "Syrian Arab Republic"                                 ~ "Syria",
    country == "The former Yugoslav republic of Macedonia"            ~ "Macedonia",
    country == "Trinidad and Tobago"                                  ~ "Trinidad & Tobago",
    country == "United Kingdom of Great Britain and Northern Ireland" ~ "United Kingdom",
    country == "United Republic of Tanzania"                          ~ "Tanzania",
    country == "United States of America"                             ~ "United States",
    country == "Venezuela (Bolivarian Republic of)"                   ~ "Venezuela",
    country == "Viet Nam"                                             ~ "Vietnam",
    country == "CÃ´te d'Ivoire"                                        ~ as.character(NA),   # UTC-8
    country == "Sao Tome and Principe"                                ~ as.character(NA),   # conflicts
    TRUE                                                              ~ as.character(country)
  )) %>% 
  filter(!is.na(country))

infantmortanti <- infantmortdata %>%
  anti_join(countries, by = "country") %>%
  select(country) %>%
  arrange(country) %>% 
  unique()
dim(infantmortanti)

rm(list = c("infantmort_raw", "infantmortanti"))
```

<!-- World Health Organization life expectancy data: -->

```{r lifeexp_import, include = FALSE, echo = FALSE, eval = TRUE}
lifeexp_raw <- read_csv("data/WHO_lifeexp.csv")
lifeexp_raw <- lifeexp_raw %>% select(1:3, 6)

lifeexp_sub <- lifeexp_raw

colnames(lifeexp_sub) <- c("country", "year", "birth_MF", "sixty_MF")
lifeexpdata <- lifeexp_sub %>% 
  slice(2:length(country)) %>% 
  mutate(year = as.numeric(year)) %>% 
  mutate(birth_MF = as.numeric(birth_MF)) %>% 
  mutate(sixty_MF = as.numeric(sixty_MF)) %>% 
  filter(year == 2016) %>% 
  select(-year)
```

<!-- Testing against `countries` and correcting for conflicts: -->

```{r lifeexp_countrytest, include = FALSE, echo = FALSE, eval = TRUE}
lifeexpanti <- lifeexpdata %>%
  anti_join(countries, by = "country") %>%
  select(country) %>%
  arrange(country) %>% 
  unique()
dim(lifeexpanti)

lifeexpdata <- lifeexpdata %>% 
  mutate(country = case_when(
    country == "Antigua and Barbuda"                                  ~ "Antigua & Barbuda",
    country == "Bolivia (Plurinational State of)"                     ~ "Bolivia",
    country == "Bosnia and Herzegovina"                               ~ "Bosnia & Herzegovina",
    country == "Brunei Darussalam"                                    ~ "Brunei",
    country == "Cabo Verde"                                           ~ "Cape Verde",
    country == "Congo"                                                ~ "Congo - Brazzaville",
    country == "Democratic People's Republic of Korea"                ~ "North Korea",
    country == "Democratic Republic of the Congo"                     ~ "Congo - Kinshasa",
    country == "Eswatini"                                             ~ "Swaziland",
    country == "Iran (Islamic Republic of)"                           ~ "Iran",
    country == "Lao People's Democratic Republic"                     ~ "Laos",
    country == "Myanmar"                                              ~ "Myanmar (Burma)",
    country == "Republic of Korea"                                    ~ "South Korea",
    country == "Republic of Moldova"                                  ~ "Moldova",
    country == "Russian Federation"                                   ~ "Russia",
    country == "Saint Lucia"                                          ~ "St. Lucia",
    country == "Saint Vincent and the Grenadines"                     ~ "St. Vincent & Grenadines",
    country == "Syrian Arab Republic"                                 ~ "Syria",
    country == "The former Yugoslav republic of Macedonia"            ~ "Macedonia",
    country == "Trinidad and Tobago"                                  ~ "Trinidad & Tobago",
    country == "United Kingdom of Great Britain and Northern Ireland" ~ "United Kingdom",
    country == "United Republic of Tanzania"                          ~ "Tanzania",
    country == "United States of America"                             ~ "United States",
    country == "Venezuela (Bolivarian Republic of)"                   ~ "Venezuela",
    country == "Viet Nam"                                             ~ "Vietnam",
    country == "CÃ´te d'Ivoire"                                        ~ as.character(NA),   # UTC-8
    country == "Sao Tome and Principe"                                ~ as.character(NA),   # conflicts
    TRUE                                                              ~ as.character(country)
  )) %>% 
  filter(!is.na(country))

lifeexpanti <- lifeexpdata %>%
  anti_join(countries, by = "country") %>%
  select(country) %>%
  arrange(country) %>% 
  unique()
dim(lifeexpanti)

# Removing unneeded files

rm(list = c("lifeexp_raw", "lifeexp_sub"))
```

<!-- World Bank Gross Domestic Product (GDP) data: -->

```{r GDP_import, include = FALSE, echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE}
GDPraw <- read_csv("data/GDPdata.csv")

GDPcolnames <- GDPraw %>% slice(4:4)
GDPsub <- GDPraw %>% 
  slice(-(1:4))
colnames(GDPsub) <- GDPcolnames

GDPdata <- GDPsub %>% 
  rename(country = `Country Name`) %>% 
  rename(country3 = `Country Code`) %>% 
  select(-(3:44)) %>%
  gather(3:20, key = "year", value = "GDP_USD_2018") %>%      # Valuation is in $US 2018
  mutate(year = as.numeric(year)) %>% 
  filter(year == 2016) %>% 
  select(-year)
```

<!-- Testing against `countries` and correcting for conflicts: -->

```{r GDP_countrytest, include = FALSE, echo = FALSE, eval = TRUE}
GDPanti <- GDPdata %>%
  anti_join(countries, by = "country3") %>%
  select(country3, country) %>%
  arrange(country3, country) %>% 
  unique()
dim(GDPanti)

GDPdata <- GDPdata %>% 
  mutate(country3 = case_when(
    country3 == "XKX" ~ "XKS",
    country3 == "CHI" ~ as.character(NA), # Channel Islands
    country3 %in% c("ARB", "CEB", "CSS", "EAP", "EAR", "EAS", "ECA", "ECS", "EMU",  # Region-of-world codes
                    "EUU", "FCS", "HIC", "HPC", "IBD", "IBT", "IDA", "IDB", "IDX",  # (not country codes)
                    "INX", "LAC", "LCN", "LDC", "LIC", "LMC", "LMY", "LTE", "MEA", 
                    "MIC", "MNA", "NAC", "OED", "OSS", "PRE", "PSS", "PST", "SAS", 
                    "SSA", "SSF", "SST", "TEA", "TEC", "TLA", "TMN", "TSA", "TSS", 
                    "UMC", "WLD") ~ as.character(NA),
    TRUE ~ as.character(country3)
  )) %>% 
  filter(!is.na(country3)) %>% 
  select(-country)

GDPanti <- GDPdata %>%
  anti_join(countries, by = "country3") %>%
  select(country3) %>%
  arrange(country3) %>% 
  unique()
dim(GDPanti)

# Removing unneeded files

rm(list = c("GDPraw", "GDPsub", "GDPcolnames", "GDPanti"))
```

This process of importing, wrangling, and testing against the `countries` dataframe was largely the same for all other datasets of interest, with minor differences depending on the native structure of the data.  Again, for brevity, those steps are not shown here, but are available on the project GitHub site [@kmpgit].


### *Combining individual data files into one dataframe*

All datasets were merged into a single dataframe using serial `join()` statements, and the resulting dataset was filtered to omit countries without data.

```{r combine, include = TRUE, echo = TRUE, eval = TRUE}
joindata_1 <- full_join(countries, HDIdata, by = "country")
joindata_2 <- left_join(joindata_1, SPIdata, by = "country3")
joindata_3 <- left_join(joindata_2, WHRdata, by = "country")
joindata_4 <- left_join(joindata_3, genderdata, by = "country")
joindata_5 <- left_join(joindata_4, infantmortdata, by = "country")
joindata_6 <- left_join(joindata_5, lifeexpdata, by = "country")
joindata_7 <- left_join(joindata_6, GDPdata, by = "country3")

joinsub <- joindata_7 %>% 
  arrange(country) %>% 
  mutate(exclude_flag = case_when(
    is.na(HDIrank) == TRUE & 
      is.na(HDIindex) == TRUE &
      is.na(HDI_cat) == TRUE &
      is.na(SPI) == TRUE &
      is.na(happiness) == TRUE &
      is.na(genderequality_index) == TRUE &
      is.na(infantmort) == TRUE &
      is.na(birth_MF) == TRUE &
      is.na(sixty_MF) == TRUE &
      is.na(GDP_USD_2018) == TRUE             ~ TRUE,
    TRUE                                      ~ FALSE
  )) %>% 
  filter(exclude_flag == FALSE) %>% 
  select(-exclude_flag)

alldata <- joinsub
len <- dim(alldata)[[1]]

# write_csv(alldata, paste0("data/alldata_", lubridate::today(),".csv"))  # Uncomment to export data
```

```{r join_remove, include = FALSE, echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE}
# Removing unneeded files

rm(list = c("joindata_1", "joindata_2", "joindata_3", "joindata_4",
            "joindata_5", "joindata_6", "joindata_7", "joinsub"))
```

The final dataframe, titled `alldata`, contains the following:

| **Source**       	| **Variable Name**    	| **Description**                                  	|
|------------------	|----------------------	|--------------------------------------------------	|
| @un_dvlpt        	| HDIrank              	| Human Development Index ranking                  	|
| @un_dvlpt        	| HDIindex             	| HDI index value (scale of 0:1)                   	|
| @un_dvlpt        	| HDI_cat              	| HDI index category (5 levels)                    	|
| @socialprog      	| SPI                  	| Social Progress Index value (scale of 0:100)     	|
| @whr             	| happiness            	| World Happiness Score (scale of 0:10)            	|
| @wef_gender      	| genderequality_index 	| Gender Equality Index (scale of 0:1)             	|
| @who_infantmort  	| infantmort           	| Infant mortality rate                            	|
| @who_life        	| birth_MF             	| Life expectancy at birth, males & females        	|
| @who_life        	| sixty_MF             	| Life expectancy at 60 years, males & females     	|
| @worldbank_gdp   	| GDP_USD_2018         	| 2016 Gross Domestic Product (valued in $US 2018) 	|


### *Visualizations*

Univariate and sensible bivariate analyses were generated to explore the data.

Exploring the Human Development Index variables:

```{r HDIplots, include = TRUE, echo = TRUE, warning = FALSE, message = FALSE, fig.width = 10, fig.height = 4}
HDIindex_hist <- ggplot(data = alldata, aes(x = HDIindex)) +
  geom_histogram(bins = ceiling(sqrt(len - sum(is.na(alldata$HDIindex))))) +
  xlab("Human Development Index") +
  ylab("Count") +
  ggtitle("Human Development Index Distribution")

HDIcat_bar <- ggplot(data = alldata, aes(x = HDI_cat)) +
  geom_bar() +
  geom_text(stat = "count", aes(label = ..count..), color = "#233b43",
            hjust = 0.5, position = position_stack(vjust = 0.5)) +
  xlab("Human Development Category") +
  ylab("Count") +
  ggtitle("Human Development Index Counts \nby Category")

grid.arrange(HDIindex_hist, HDIcat_bar, nrow = 1)
```

The top 5 countries by HDI rank are:

```{r HDItop, include = TRUE, echo = TRUE, eval = TRUE}
HDIsub <- alldata %>% 
  select(country, HDIrank, HDIindex) %>% 
  arrange(HDIrank) %>% 
  filter(!is.na(HDIindex) == TRUE) %>% 
  mutate(HDIindex = round(HDIindex, digits = 4))
HDItop <- head(HDIsub, 5) %>% kable(format = "markdown")
HDItop
```

and the bottom 5 are:

```{r HDIbot, include = TRUE, echo = TRUE, eval = TRUE}
HDIbot <- tail(HDIsub, 5) %>% kable(format = "markdown")
HDIbot
```

Exploring the Social Progress Index data:

```{r SPIplot, include = TRUE, echo = TRUE, warning = FALSE, message = FALSE}
SPI_hist <- ggplot(data = alldata, aes(x = SPI)) +
  geom_histogram(bins = ceiling(sqrt(len - sum(is.na(alldata$SPI))))) +
  xlab("Social Progress Index") +
  ylab("Count") +
  ggtitle("Social Progress Index Distribution")
SPI_hist
```

Exploring the World Happiness Report data:

```{r happinessplot, include = TRUE, echo = TRUE, warning = FALSE, message = FALSE}
happiness_hist <- ggplot(data = alldata, aes(happiness)) +
  geom_histogram(bins = ceiling(sqrt(len - sum(is.na(alldata$happiness))))) +
  xlab("Happiness Score") +
  ylab("Count") +
  ggtitle("Happiness Score Distribution")
happiness_hist
```

Exploring the gender equality index data:

```{r genderplot, include = TRUE, echo = TRUE, warning = FALSE, message = FALSE}
gender_hist <- ggplot(data = alldata, aes(x = genderequality_index)) +
  geom_histogram(bins = ceiling(sqrt(len - sum(is.na(alldata$genderequality_index))))) +
  xlab("Gender Equality Index") +
  ylab("Count") +
  ggtitle("Gender Equality Index Distribution")
gender_hist
```

Exploring the WHO infant mortality rate data:

```{r infantmortplot, include = TRUE, echo = TRUE, warning = FALSE, message = FALSE}
infantmort_hist <- ggplot(data = alldata, aes(x = infantmort)) + 
  geom_histogram(bins = ceiling(sqrt(len - sum(is.na(alldata$genderequality_index))))) +
  xlab("Probability of Infant Mortality") +
  ylab("Count") +
  ggtitle("Infant Mortality Distribution")
infantmort_hist
```

Exploring the WHO life expectancy data:

```{r lifeexpplot, include = TRUE, echo = TRUE, warning = FALSE, message = FALSE, fig.width = 10, fig.height = 4}
lifeexp_birth_box <- ggplot(data = alldata, aes(y = birth_MF)) +
  geom_boxplot() +
  ylim(0, 100) +
  ylab("Total Life Expectancy (years)") +
  ggtitle("...at Birth") +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank())

lifeexp_sixty_box <- ggplot(data = alldata, aes(y = 60 + sixty_MF)) +
  geom_boxplot() +
  ylim(0, 100) +
  ylab("") +
  ggtitle("...at Age 60") +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.line.y.left = element_blank())

grid.arrange(lifeexp_birth_box, lifeexp_sixty_box, nrow = 1,
             top = textGrob("Total Life Expectancy...",
                            gp = gpar(fontsize = 16, fontface = "bold", col = "#545454")))
```

The summary statistics (in millions) for the GDP data are:

```{r GDPsumm, include = TRUE, echo = TRUE, warning = FALSE, message = FALSE}
GDPsumm <- broom::tidy(round(summary(alldata$GDP_USD_2018 / 1000000), digits = 4)) %>% 
  kable(format = "markdown")
GDPsumm
```

Taking the log transform and plotting:

```{r GDPplot, include = TRUE, echo = TRUE, warning = FALSE, message = FALSE}
GDP_hist <- ggplot(data = alldata, aes(x = log(GDP_USD_2018))) +
  geom_histogram(bins = ceiling(sqrt(len - sum(is.na(alldata$GDP_USD_2018))))) +
  xlab("log(GDP) ($US 2018)") +
  ylab("Count") +
  ggtitle("Gross Domestic Product Distribution, Log Transform") +
  scale_x_continuous(labels = scales::dollar_format(prefix = "$"))
GDP_hist
```

Investigating pairwise relationships between continuous variables:

```{r calc_corrplot, include = TRUE, echo = TRUE, message = FALSE, warning = FALSE, fig.width = 10, fig.height = 8}
alldata <- alldata %>% mutate(logGDP = log(GDP_USD_2018))

corrplot <- ggpairs(data = alldata, columns = c(4, 6:11, 13),
                    title = "Correlation Matrix, Continuous Variables")
corrplot
```

Strong positive linear relationships are seen between `HDIindex` and `SPI`, `happiness`, and `birth_MF`; between `SPI` and `happiness`, `birth_MF`, and `sixty_MF`; and between `happiness` and `sixty_MF`.  Additionally, strong positive relationships that are possibly nonlinear are seen between `HDI_index` and `sixty_MF`, and between `birth_MF` and `sixty_MF`.

Strong negative relationships are seen between `infantmort` and `birth_MF`, between `HDIindex` and `infantmort`, and between `SPI` and `infantmort`, though the latter two of these may not necessarily be linear.  A strong negative nonlinear relationship is seen between `infantmort` and `sixty_MF`.

<!-- Add one or two interesting country-level plots here (http://stat545.com/block014_factors.html) -->

### **Clustering Analysis**



## **Results**


## **Discussion**



### *Limitations*



## **Conclusion**



## **References**